<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ADK-Programmers-Guides: ADK-TEC Programmers Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="verifone.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="verifonelogo.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ADK-Programmers-Guides
   &#160;<span id="projectnumber">5.0.3-CD1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('pg_tec_programmers_guide.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">ADK-TEC Programmers Guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="sec_tec_preface"></a>
Preface</h1>
<p>This document is for programmers and developers who want to understand and use the ADK-TEC.</p>
<h2><a class="anchor" id="subsec_tec_audience"></a>
Audience</h2>
<p>This guide provides all the information required for application developers to integrate and utilize the functionality of the ADK-TEC.</p>
<h2><a class="anchor" id="subsec_tec_organization"></a>
Organization</h2>
<p>This guide is organized as follows:</p>
<p><a class="el" href="pg_tec_programmers_guide.html#sec_tec_introduction">Introduction</a>: Provides a summary of ADK-TEC.</p>
<p><a class="el" href="pg_tec_programmers_guide.html#sec_tec_use_cases">Use Cases</a>: Presents typical flows.</p>
<p><a class="el" href="pg_tec_programmers_guide.html#sec_tec_getting_started">Getting Started</a>: Presents an introduction in ADK-TEC usage.</p>
<p><a class="el" href="pg_tec_programmers_guide.html#sec_tec_programming">Programming</a>: Supplies ADK-TEC programming information.</p>
<p><a class="el" href="pg_tec_programmers_guide.html#sec_tec_system_setup_and_requirements">System Setup and Requirements</a>: Supplies information about required dependencies.</p>
<p><a class="el" href="pg_tec_programmers_guide.html#sec_tec_pp1000">PP1000</a>: Supplies information about pairing and PIN transfer with PP1000.</p>
<p><a class="el" href="pg_tec_programmers_guide.html#sec_tec_troubleshooting">Troubleshooting</a>: Gives solutions for possible issues in ADK-TEC.</p>
<p><a class="el" href="pg_tec_programmers_guide.html#sec_tec_appendix">Appendix</a>: Links to related documents.</p>
<h1><a class="anchor" id="sec_tec_introduction"></a>
Introduction</h1>
<p>ADK-TEC provides <b> technology selection </b> functionality. Supported technologies are</p><ul>
<li>Magstripe cards</li>
<li>EMV contact chip cards</li>
<li>EMV contactless cards and mobile phones</li>
<li>Contactless NFC cards (Mifare, Felicy, ISO, ...)</li>
<li>Contactless Value Added Service (VAS) solutions</li>
</ul>
<p>To make use of ADK-TEC you need the following components:</p><ul>
<li><a class="el" href="tec_8h.html">tec.h</a></li>
<li>libtec.so</li>
</ul>
<p>Additionally you need</p><ul>
<li>ADK-MSR, see <a href="./pg_msr_programmers_guide.html" title="ADK-MSR Programmers Guide">ADK-MSR Programmers Guide</a></li>
<li>ADK-EMV, see<ul>
<li><a href="./pg_emv_contact_users_guide.html" title="ADK-EMV Contact Programmers Guide">ADK-EMV Contact Programmers Guide</a></li>
<li><a href="./pg_emv_contactless_users_guide.html" title="ADK-EMV Contactless Programmers Guide">ADK-EMV Contactless Programmers Guide</a></li>
</ul>
</li>
<li>ADK-NFC, see <a href="./pg_nfc_users_guide.html" title="ADK-NFC Programmers Guide">ADK-NFC Programmers Guide</a></li>
</ul>
<h2><a class="anchor" id="sec_tec_intro_flow_overview"></a>
Flow Overview</h2>
<p>On <b> terminal startup </b> the application needs to setup the components (see below picture, dashed lines):</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Package name </th><th class="markdownTableHeadNone">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>tec-doc-x.x.x-xx.zip</code>  </td><td class="markdownTableBodyNone">Documentation  </td></tr>
</table>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">ADK-MSR </th><th class="markdownTableHeadNone">ADK-EMV Contact </th><th class="markdownTableHeadNone">ADK-EMV Contactless </th><th class="markdownTableHeadNone">ADK-NFC </th><th class="markdownTableHeadNone">ADK-TEC (black line)  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="msr_8h.html#ac3c6f568aa57690a8b369936fc362c2a">MSR_SetOptions()</a> if desired </td><td class="markdownTableBodyNone"><a class="el" href="group___f_u_n_c___i_n_i_t.html#ga514e39585c5a6b79632ac317593ff592" title="Initialize EMV ADK.">EMV_CT_Init_Framework()</a> </td><td class="markdownTableBodyNone"><a class="el" href="group___f_u_n_c___i_n_i_t.html#ga63240773908b46180eeec866ef33f93f" title="Initialize EMV ADK.">EMV_CTLS_Init_Framework()</a> </td><td class="markdownTableBodyNone"><a class="el" href="sdi__nfc_8h.html#a7a9419cd6aa7aa9185fb249ce761ae0f">NFC_Client_Init()</a> </td><td class="markdownTableBodyNone"><a class="el" href="tec_8h.html#aa237be1f0249503d0b959d3800f1ee34">cts_SetOptions()</a> if desired  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"><a class="el" href="group___f_u_n_c___c_o_n_f.html#ga351c2deba9865081c314d818463f20c9" title="Set terminal specific data and perform verification and saving of data.">EMV_CT_SetTermData()</a> </td><td class="markdownTableBodyNone"><a class="el" href="group___f_u_n_c___c_o_n_f.html#gac5ce9781bba083028538f9e77c2d58f3" title="set terminal specific data and perform verification and saving of data">EMV_CTLS_SetTermData()</a> </td><td class="markdownTableBodyNone"><a class="el" href="titusstubs_8cpp.html#ad0a349a0904d698fea9fffa004cb3eb3">NFC_Terminal_Config()</a> </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"><a class="el" href="group___f_u_n_c___c_o_n_f.html#ga73ca1735defbb65a1aae2ead1de70233" title="Set application specific data and perform verification and saving of data.   Has to be called once pe...">EMV_CT_SetAppliData()</a> </td><td class="markdownTableBodyNone"><a class="el" href="group___f_u_n_c___c_o_n_f.html#gadc7f2eba5fd3e941d0ddb65a936a0776" title="Set application specific data and perform verification and saving of data.">EMV_CTLS_SetAppliDataSchemeSpecific()</a> </td><td class="markdownTableBodyNone"><a class="el" href="titusstubs_8cpp.html#a8816583d91da702a6c7e2143ed68f7d9">NFC_VAS_UpdateConfig()</a> </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"><a class="el" href="group___f_u_n_c___c_o_n_f.html#gade5b2bbc6ab46c4b7d9efa991b696ad2" title="Stores the specified CAP key.">EMV_CT_StoreCAPKey()</a> </td><td class="markdownTableBodyNone"><a class="el" href="group___f_u_n_c___c_o_n_f.html#ga3e03f6dd283e873cbcd6b8e4bb78f09a" title="Stores the specified CAP key.">EMV_CTLS_StoreCAPKey()</a> </td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td></tr>
</table>
<div class="image">
<img src="ComponentOverview.png" alt=""/>
</div>
<p><b> Transaction flow</b>:</p><ul>
<li>Application prepares components (dashed lines):<ul>
<li>ADK-EMV Contactless<ul>
<li>if not <a class="el" href="group___t_e_c___s_t_a_r_t___o_p_t_i_o_n_s.html#gaeff0a0e1b335597ea1ec0781f15edb08">CTS_PURE_CARD_DETECTION</a>: <a class="el" href="group___f_u_n_c___f_l_o_w.html#ga1a86c76dcf8fec6e97ead6cf8f2717ff" title="Set up a CTLS EMV transaction.">EMV_CTLS_SetupTransaction()</a></li>
</ul>
</li>
<li>ADK-NFC if VAS desired: <a class="el" href="titusstubs_8cpp.html#a8ee28a30cc5757bdd4d9ac413fe7ef17">NFC_VAS_PreLoad()</a></li>
</ul>
</li>
<li>Application starts card detection<ul>
<li>invoke <a class="el" href="tec_8h.html#ac6699fe32fc23e90713eb617e9ff25e7">cts_StartSelection()</a> (black line)</li>
<li>ADK-TEC starts a thread to poll the involved components (solid blue lines)</li>
</ul>
</li>
<li>User swipes, inserts, or taps a card (or mobile phone)<ul>
<li>ADK-TEC gets notification about this event (solid blue lines)</li>
</ul>
</li>
<li>ADK-TEC signals card detection to the application (black line)</li>
<li>Application completes the transaction (dashed lines)<ul>
<li>if a magstripe card was swiped:<ul>
<li>use ADK-MSR functions to fetch the read data</li>
</ul>
</li>
<li>if a card was inserted:<ul>
<li>use ADK-EMV Contact to make the transaction</li>
</ul>
</li>
<li>if a card (or mobile phone) was tapped:<ul>
<li>if CTLS EMV is signaled:<ul>
<li>transaction was already done</li>
<li>use ADK-EMV Contactless to fetch the results</li>
</ul>
</li>
<li>if CTLS NFC or VAS is signaled:<ul>
<li>use ADK-NFC to realize the desired APDUs</li>
<li>if desired (and possible): do EMV transaction by means of ADK-EMV Contactless</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="sec_tec_intro_android"></a>
Android</h2>
<p>In Android the ADK-TEC is hidden inside SDI. So application has to use the "Card Detection (23-01)" from <a href="./pg_sdi_users_guide.html" title="ADK-SDI Programmers Guide">ADK-SDI Programmers Guide</a>.</p>
<h2><a class="anchor" id="sec_tec_intro_vos3"></a>
VOS3</h2>
<p>In VOS3 ADK-TEC is accessible through SDI. The ADK-TEC-interface is rebuild in <a href="./pg_sdiclient_users_guide.html" title="ADK-SDI-Client Programmers Guide">ADK-SDI-Client Programmers Guide</a>.</p>
<h2><a class="anchor" id="sec_msr_intro_2piece"></a>
Two-Piece Solution</h2>
<p>Former Two-Piece Solution with Client/Server architecture for MSR, TEC, ... is not supported anymore. <br  />
 SDI EPP has to be used instead (see <a href="./pg_sdi_users_guide.html" title="ADK-SDI Programmers Guide">ADK-SDI Programmers Guide</a>).</p>
<h1><a class="anchor" id="sec_tec_use_cases"></a>
Use Cases</h1>
<h2><a class="anchor" id="subsec_tec_emv_msr_ct_ctls"></a>
Magstripe and EMV Contact, on Contactless EMV and transparent ISO APDU</h2>
<p><b>Requirement:</b> <br  />
 All three technologies shall be detected: Magstripe Card Swipe, Contact Chipcard Insertion, Contactless Card (or Mobile Phone) Tap. <br  />
 On <em>Contactless interface an EMV payment</em> shall be done.</p>
<p><b>Flow</b> (see below diagram): <br  />
 If not <a class="el" href="group___t_e_c___s_t_a_r_t___o_p_t_i_o_n_s.html#gaeff0a0e1b335597ea1ec0781f15edb08">CTS_PURE_CARD_DETECTION</a>: Before EVERY start the application has to set up EMV Contactless (call <a class="el" href="group___f_u_n_c___f_l_o_w.html#ga1a86c76dcf8fec6e97ead6cf8f2717ff" title="Set up a CTLS EMV transaction.">EMV_CTLS_SetupTransaction()</a>).</p>
<p>To start technology selection the application calls <a class="el" href="tec_8h.html#ac6699fe32fc23e90713eb617e9ff25e7">cts_StartSelection()</a> with <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gadbc63cc59da76fff7974cd5631f56662">CTS_CHIP</a>, <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a>, and <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#ga56e64c2a97c61e8cb043de2852986a3a">CTS_CTLS</a>. <br  />
 TEC component will start a thread to poll for swipe, insert or tap.</p>
<p>Once a card (or mobile phone) is detected the application gets the result by means of <a class="el" href="tec_8h.html#aee5b104d8ad6e85feddb685379cdbf0c">cts_WaitSelection()</a>. <br  />
 Parameter <code>usedTechnology</code> informs which technology is used:</p><ol type="1">
<li><a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a>: A magnetic card was swiped. <br  />
 Application has to read the magstripe data (with help of <a href="./pg_msr_programmers_guide.html" title="ADK-MSR Programmers Guide">ADK-MSR Programmers Guide</a>) and process transaction.</li>
<li><a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gadbc63cc59da76fff7974cd5631f56662">CTS_CHIP</a>: A contact chip card was inserted. <br  />
 Chip may already be activated (depending on <a class="el" href="group___t_e_c___s_t_a_r_t___o_p_t_i_o_n_s.html#ga1073825ee49c63471bef39392d6df7e6">CTS_NO_POWERON</a>). <br  />
 Application has to execute the chip transaction by means of <a href="./pg_emv_contact_users_guide.html" title="ADK-EMV Contact Programmers Guide">ADK-EMV Contact Programmers Guide</a>.</li>
<li><a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#ga56e64c2a97c61e8cb043de2852986a3a">CTS_CTLS</a>: A contactless card or mobile phone was tapped (see <a href="./pg_emv_contactless_users_guide.html" title="ADK-EMV Contactless Programmers Guide">ADK-EMV Contactless Programmers Guide</a>).<ul>
<li>if <a class="el" href="group___t_e_c___s_t_a_r_t___o_p_t_i_o_n_s.html#gaeff0a0e1b335597ea1ec0781f15edb08">CTS_PURE_CARD_DETECTION</a>: <br  />
 Chip card was activated. <br  />
 Application can communicate with chip by means of EMV transparent commands (<a class="el" href="group___f_u_n_c___i_c_c.html#gafbcdb0278723b9629eb7c12532119e2d" title="Send chip card command and receive response.">EMV_CTLS_SmartISO()</a> and others). <br  />
 And may do a EMV transaction starting with <a class="el" href="group___f_u_n_c___f_l_o_w.html#ga1a86c76dcf8fec6e97ead6cf8f2717ff" title="Set up a CTLS EMV transaction.">EMV_CTLS_SetupTransaction()</a>.</li>
<li>else: <br  />
 The complete EMV transaction was already done. <br  />
 The application has to fetch the results with <a class="el" href="group___f_u_n_c___f_l_o_w.html#gaf23f6f87fe90619810470fad7d11f321" title="CTLS EMV transaction (offline part ... including 1st cryptogram, depends on CTLS scheme)">EMV_CTLS_ContinueOffline()</a>.</li>
</ul>
</li>
</ol>
<div class="image">
<img src="UseCase1-MSR-CT-CTLS.png" alt=""/>
</div>
<h2><a class="anchor" id="subsec_tec_msr_ct_iso"></a>
Magstripe and EMV Contact, on Contactless NFC</h2>
<p><b>Requirement:</b> <br  />
 All three technologies shall be detected: Magstripe Card Swipe, Contact Chipcard Insertion, Contactless Card (or Mobile Phone) Tap. <br  />
 On <em>Contactless interface several card types</em> shall be handled: MiFare, Felica, EMV, and others.</p>
<p><b>Flow</b> (see below diagram): <br  />
 To start technology selection the application calls <a class="el" href="tec_8h.html#ac6699fe32fc23e90713eb617e9ff25e7">cts_StartSelection()</a> with <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gadbc63cc59da76fff7974cd5631f56662">CTS_CHIP</a>, <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a>, and <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#ga56e64c2a97c61e8cb043de2852986a3a">CTS_CTLS</a>. <br  />
 Additionally <a class="el" href="group___t_e_c___s_t_a_r_t___o_p_t_i_o_n_s.html#gaafe9099680a56edd52a1258a797efa07">CTS_NFC_ENABLE</a> and options[12..15] (NFC technologies) have to be set. <br  />
 TEC component will start a thread to poll for swipe, insert or tap.</p>
<p>Once a card (or mobile phone) is detected the application gets the result by means of <a class="el" href="tec_8h.html#aee5b104d8ad6e85feddb685379cdbf0c">cts_WaitSelection()</a>. <br  />
 Parameter <code>usedTechnology</code> informs which technology is used:</p><ul>
<li><a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a>: A magnetic card was swiped. <br  />
 Application has to read the magstripe data (with help of <a href="./pg_msr_programmers_guide.html" title="ADK-MSR Programmers Guide">ADK-MSR Programmers Guide</a>) and process transaction.</li>
<li><a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gadbc63cc59da76fff7974cd5631f56662">CTS_CHIP</a>: A contact chip card was inserted. <br  />
 Chip may already be activated (depending on <a class="el" href="group___t_e_c___s_t_a_r_t___o_p_t_i_o_n_s.html#ga1073825ee49c63471bef39392d6df7e6">CTS_NO_POWERON</a>). <br  />
 Application has to execute the chip transaction by means of <a href="./pg_emv_contact_users_guide.html" title="ADK-EMV Contact Programmers Guide">ADK-EMV Contact Programmers Guide</a>.</li>
<li><a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#ga56e64c2a97c61e8cb043de2852986a3a">CTS_CTLS</a> + <a class="el" href="tec__common_8h.html#a56386219739d173835a83194608fedea">CTS_DATA_TLV</a>: A contactless card or mobile phone was tapped. <br  />
 Parameter <code>dataBuffer</code> contains NFC related data in TLV format, see <a class="el" href="group___t_e_c___d_a_t_a___t_a_g_s.html">TEC result data tags</a>. <br  />
 Application shall use <a href="./pg_nfc_users_guide.html" title="ADK-NFC Programmers Guide">ADK-NFC Programmers Guide</a> to realize the desired functionality, e.g.:<ul>
<li>Felica</li>
<li>Mifare</li>
<li>APDU exchange</li>
</ul>
</li>
</ul>
<p><b>Automatically perform an EMV Contacless transaction:</b> <br  />
 The application may set <a class="el" href="group___t_e_c___s_t_a_r_t___o_p_t_i_o_n_s.html#ga16d617787fe23f80aae81a4c3bc944bf">CTS_EMV_AFTER_NFC_ISO</a>. <br  />
 In that case it also needs to call <a class="el" href="group___f_u_n_c___f_l_o_w.html#ga1a86c76dcf8fec6e97ead6cf8f2717ff" title="Set up a CTLS EMV transaction.">EMV_CTLS_SetupTransaction()</a> before <a class="el" href="tec_8h.html#ac6699fe32fc23e90713eb617e9ff25e7">cts_StartSelection()</a>. <br  />
 ADK-TEC will perform an EMV contactless transaction if an ISO14443 card is tapped. <br  />
 If another card is used the application will get the above mentioned NFC results.</p>
<div class="image">
<img src="UseCase2-MSR-CT-CTLS-NFC.png" alt=""/>
</div>
<h2><a class="anchor" id="subsec_tec_msr_ct_nfc"></a>
Magstripe and EMV Contact, on Contactless EMV and VAS (Value Added Services, Wallets)</h2>
<p><b>Requirement:</b> <br  />
 All three technologies shall be detected: Magstripe Card Swipe, Contact Chipcard Insertion, Contactless Card (or Mobile Phone) Tap. <br  />
 On Contactless interface it's needed to handle <em> Value Added Services (VAS) Wallets </em> and EMV payments.</p>
<p><b>Flow</b> (see below diagram): <br  />
 Application has to prepare ADK-NFC by means of <a class="el" href="titusstubs_8cpp.html#a8ee28a30cc5757bdd4d9ac413fe7ef17">NFC_VAS_PreLoad()</a> (see <a href="./pg_nfc_users_guide.html" title="ADK-NFC Programmers Guide">ADK-NFC Programmers Guide</a>). <br  />
 If the used VAS config includes "Pay" (= EMV) than <a class="el" href="group___f_u_n_c___f_l_o_w.html#ga1a86c76dcf8fec6e97ead6cf8f2717ff" title="Set up a CTLS EMV transaction.">EMV_CTLS_SetupTransaction()</a> is needed.</p>
<p><br  />
 To start technology selection the application calls <a class="el" href="tec_8h.html#ac6699fe32fc23e90713eb617e9ff25e7">cts_StartSelection()</a> with <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gadbc63cc59da76fff7974cd5631f56662">CTS_CHIP</a>, <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a>, and <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#ga56e64c2a97c61e8cb043de2852986a3a">CTS_CTLS</a>. <br  />
 Additionally <a class="el" href="group___t_e_c___s_t_a_r_t___o_p_t_i_o_n_s.html#ga4678a7752f0337b236971dcd370edf93">CTS_VAS_ENABLE</a> has to be set. <br  />
 TEC component will start a thread to poll for swipe, insert or tap.</p>
<p>Once a card (or mobile phone) is detected the application gets the result by means of <a class="el" href="tec_8h.html#aee5b104d8ad6e85feddb685379cdbf0c">cts_WaitSelection()</a>. <br  />
 Parameter <code>usedTechnology</code> informs which technology is used:</p><ul>
<li><a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a>: A magnetic card was swiped. <br  />
 Application has to read the magstripe data (with help of <a href="./pg_msr_programmers_guide.html" title="ADK-MSR Programmers Guide">ADK-MSR Programmers Guide</a>) and process transaction.</li>
<li><a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gadbc63cc59da76fff7974cd5631f56662">CTS_CHIP</a>: A contact chip card was inserted. <br  />
 Chip may already be activated (depending on <a class="el" href="group___t_e_c___s_t_a_r_t___o_p_t_i_o_n_s.html#ga1073825ee49c63471bef39392d6df7e6">CTS_NO_POWERON</a>). <br  />
 Application has to execute the chip transaction by means of <a href="./pg_emv_contact_users_guide.html" title="ADK-EMV Contact Programmers Guide">ADK-EMV Contact Programmers Guide</a>.</li>
<li><a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#ga56e64c2a97c61e8cb043de2852986a3a">CTS_CTLS</a> + <a class="el" href="tec__common_8h.html#a56386219739d173835a83194608fedea">CTS_DATA_TLV</a>: A contactless card or mobile phone was tapped. <br  />
 Parameter <code>dataBuffer</code> contains VAS related data in TLV format, see <a class="el" href="group___t_e_c___d_a_t_a___t_a_g_s.html">TEC result data tags</a>. <br  />
 If result data contains <a class="el" href="group___t_e_c___d_a_t_a___t_a_g_s.html#ga6de766623c7d58220a766c7bb6722c6f">CTS_DATA_TAG_EMV_RESULT</a> the TEC processed a complete EMV transaction. <br  />
 Application has to use ADK-EMV to collect the results. <br  />
 Afterwards it can process the VAS data as needed.</li>
</ul>
<div class="image">
<img src="UseCase3-MSR-CT-CTLS-VAS.png" alt=""/>
</div>
<h1><a class="anchor" id="sec_tec_getting_started"></a>
Getting Started</h1>
<p>The following two examples show how to use technology selection (ADK-TEC):</p>
<h2><a class="anchor" id="sec_tec_sample1"></a>
Sample1: Application using ADK-TEC without callback</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="tec_8h.html">tec/tec.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;msr/msr.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_e_m_v___c_t___interface_8h.html">EMV_CT_Interface.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_e_m_v___c_t_l_s___interface_8h.html">EMV_CTLS_Interface.h</a>&quot;</span></div>
<div class="line">....</div>
<div class="line"> </div>
<div class="line">a) MSR, CT, CTLS EMV only</div>
<div class="line"><span class="comment">// initialize:</span></div>
<div class="line">EMV_CT_InitFramework(...);</div>
<div class="line">EMV_CTLS_InitFramework(...);</div>
<div class="line"><span class="comment">// setup transaction</span></div>
<div class="line"><a class="code" href="group___f_u_n_c___f_l_o_w.html#ga1a86c76dcf8fec6e97ead6cf8f2717ff">EMV_CTLS_SetupTransaction</a>(...);</div>
<div class="line"><span class="comment">// start technology selection without callback:</span></div>
<div class="line"><span class="keywordflow">if</span> (<a class="code" href="tec_8h.html#ac6699fe32fc23e90713eb617e9ff25e7">cts_StartSelection</a>(<a class="code" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gadbc63cc59da76fff7974cd5631f56662">CTS_CHIP</a>|<a class="code" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#ga56e64c2a97c61e8cb043de2852986a3a">CTS_CTLS</a>|<a class="code" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a>, 10, NULL, NULL, NULL, 0) == <a class="code" href="group___t_e_c___r_e_t_u_r_n___c_o_d_e_s.html#ga1952f713ce2bbfa1d8b54142ca52ecc4">CTS_OK</a>)</div>
<div class="line"> </div>
<div class="line">b) MSR, CT, CTLS EMV + WALLET (Remark: NFC ADK supports EITHER VAS processing OR PassTrough processing, mutual exclusive)</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> options[2] = {0};</div>
<div class="line"><span class="comment">// initialize:</span></div>
<div class="line">EMV_CT_InitFramework(...);</div>
<div class="line">EMV_CTLS_InitFramework(...);</div>
<div class="line"><a class="code" href="sdi__nfc_8h.html#a7a9419cd6aa7aa9185fb249ce761ae0f">NFC_Client_Init</a>(...);</div>
<div class="line"><a class="code" href="titusstubs_8cpp.html#ad0a349a0904d698fea9fffa004cb3eb3">NFC_Terminal_Config</a>(...);</div>
<div class="line"><a class="code" href="titusstubs_8cpp.html#a8816583d91da702a6c7e2143ed68f7d9">NFC_VAS_UpdateConfig</a>(...);</div>
<div class="line"><a class="code" href="tec_8h.html#aa237be1f0249503d0b959d3800f1ee34">cts_SetOptions</a>(...); <span class="comment">// to set VAS appID</span></div>
<div class="line"><span class="comment">// setup transaction:</span></div>
<div class="line"><a class="code" href="group___f_u_n_c___f_l_o_w.html#ga1a86c76dcf8fec6e97ead6cf8f2717ff">EMV_CTLS_SetupTransaction</a>(...);</div>
<div class="line"><a class="code" href="titusstubs_8cpp.html#a8ee28a30cc5757bdd4d9ac413fe7ef17">NFC_VAS_PreLoad</a>(...);</div>
<div class="line">options[1] = <a class="code" href="group___t_e_c___s_t_a_r_t___o_p_t_i_o_n_s.html#ga4678a7752f0337b236971dcd370edf93">CTS_VAS_ENABLE</a>;</div>
<div class="line"><span class="comment">// start technology selection without callback:</span></div>
<div class="line"><span class="keywordflow">if</span> (<a class="code" href="tec_8h.html#ac6699fe32fc23e90713eb617e9ff25e7">cts_StartSelection</a>(<a class="code" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gadbc63cc59da76fff7974cd5631f56662">CTS_CHIP</a>|<a class="code" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#ga56e64c2a97c61e8cb043de2852986a3a">CTS_CTLS</a>|<a class="code" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a>, 10, NULL, NULL, options, 2) == <a class="code" href="group___t_e_c___r_e_t_u_r_n___c_o_d_e_s.html#ga1952f713ce2bbfa1d8b54142ca52ecc4">CTS_OK</a>)</div>
<div class="line"> </div>
<div class="line">c) MSR, CT, CTLS EMV + NFC Pass Through (Remark: NFC ADK supports EITHER VAS processing OR PassTrough processing, mutual exclusive)</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> options[16] = {0};</div>
<div class="line"><span class="comment">// initialize:</span></div>
<div class="line">EMV_CT_InitFramework(...);</div>
<div class="line">EMV_CTLS_InitFramework(...);</div>
<div class="line"><a class="code" href="sdi__nfc_8h.html#a7a9419cd6aa7aa9185fb249ce761ae0f">NFC_Client_Init</a>(...);</div>
<div class="line"><span class="comment">// setup transaction:</span></div>
<div class="line"><a class="code" href="group___f_u_n_c___f_l_o_w.html#ga1a86c76dcf8fec6e97ead6cf8f2717ff">EMV_CTLS_SetupTransaction</a>(...);</div>
<div class="line">options[1] = <a class="code" href="group___t_e_c___s_t_a_r_t___o_p_t_i_o_n_s.html#gaafe9099680a56edd52a1258a797efa07">CTS_NFC_ENABLE</a>;</div>
<div class="line">options[1] |= <a class="code" href="group___t_e_c___s_t_a_r_t___o_p_t_i_o_n_s.html#ga16d617787fe23f80aae81a4c3bc944bf">CTS_EMV_AFTER_NFC_ISO</a>; <span class="comment">// optional</span></div>
<div class="line">options[15] = 0x0F; <span class="comment">// select card types</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// start technology selection without callback:</span></div>
<div class="line"><span class="keywordflow">if</span> (<a class="code" href="tec_8h.html#ac6699fe32fc23e90713eb617e9ff25e7">cts_StartSelection</a>(<a class="code" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gadbc63cc59da76fff7974cd5631f56662">CTS_CHIP</a>|<a class="code" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#ga56e64c2a97c61e8cb043de2852986a3a">CTS_CTLS</a>|<a class="code" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a>, 10, NULL, NULL, options, 16) == <a class="code" href="group___t_e_c___r_e_t_u_r_n___c_o_d_e_s.html#ga1952f713ce2bbfa1d8b54142ca52ecc4">CTS_OK</a>)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> technology;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> tlv_response = <span class="keyword">false</span>;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> data[100];</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> data_len = <span class="keyword">sizeof</span>(data);</div>
<div class="line">  <span class="keywordtype">int</span> ret;</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// wait for result:</span></div>
<div class="line">  <span class="keywordflow">while</span> ((ret = <a class="code" href="tec_8h.html#aee5b104d8ad6e85feddb685379cdbf0c">cts_WaitSelection</a>(&amp;technology, data, data_len, 100)) == <a class="code" href="group___t_e_c___r_e_t_u_r_n___c_o_d_e_s.html#ga7ee2b62641a168354503adbb06508deb">CTS_IN_PROGRESS</a>)</div>
<div class="line">  {</div>
<div class="line">    <span class="comment">// if abort request arrived (from GUI, ECR, ...) stop technology selection:</span></div>
<div class="line">    <span class="keywordflow">if</span> (aborted) <a class="code" href="tec_8h.html#acaf2d75d1b584ae97ff9ee4da47cee38">cts_StopSelection</a>();</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">switch</span> (ret)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___t_e_c___r_e_t_u_r_n___c_o_d_e_s.html#ga1952f713ce2bbfa1d8b54142ca52ecc4">CTS_OK</a>: <span class="comment">// technology detected</span></div>
<div class="line">      </div>
<div class="line">      <span class="keywordflow">if</span>(technology &amp; <a class="code" href="tec__common_8h.html#a56386219739d173835a83194608fedea">CTS_DATA_TLV</a>)</div>
<div class="line">      {</div>
<div class="line">        <span class="comment">// clear TLV response flag</span></div>
<div class="line">        technology &amp;= ~<a class="code" href="tec__common_8h.html#a56386219739d173835a83194608fedea">CTS_DATA_TLV</a>;</div>
<div class="line">        tlv_response = <span class="keyword">true</span>;</div>
<div class="line">      }</div>
<div class="line">      </div>
<div class="line">      <span class="keywordflow">switch</span> (technology)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a>:</div>
<div class="line">          <a class="code" href="msr_8h.html#ad00fdde838f486d43be689650ab58d43">MSR_GetData</a>(...);</div>
<div class="line">          <a class="code" href="msr_8h.html#aac28b2c3771f8221fc26a35f0fd6d0f8">MSR_Deactivate</a>(...);</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gadbc63cc59da76fff7974cd5631f56662">CTS_CHIP</a>:</div>
<div class="line">          <a class="code" href="group___f_u_n_c___f_l_o_w.html#ga8be6df6babc587a19f63f284b2a6f006">EMV_CT_ContinueOffline</a>(...);</div>
<div class="line">          <a class="code" href="group___f_u_n_c___f_l_o_w.html#ga42f570d2b8e66841ab9e8de7736e92d4">EMV_CT_ContinueOnline</a>(...);</div>
<div class="line">          <span class="comment">// wait for removal of chip card</span></div>
<div class="line">          <a class="code" href="tec_8h.html#a92ab7780df1f8150c6d8a9b3ab3163bf">cts_WaitCardRemoval2</a>(10);</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#ga56e64c2a97c61e8cb043de2852986a3a">CTS_CTLS</a>:</div>
<div class="line">          <span class="keywordflow">if</span> (tlv_response)</div>
<div class="line">          {</div>
<div class="line">            <span class="comment">// Evaluate the response tags for NFC Pass Through, NFC VAS processing, and EMV processing if configured in b) or c) above. </span></div>
<div class="line">          }</div>
<div class="line">          <span class="keywordflow">else</span></div>
<div class="line">          {</div>
<div class="line">            <a class="code" href="group___f_u_n_c___f_l_o_w.html#gaf23f6f87fe90619810470fad7d11f321">EMV_CTLS_ContinueOffline</a>(...);</div>
<div class="line">            <a class="code" href="group___f_u_n_c___f_l_o_w.html#ga297b6843994afaa2e7a6f5e0e4a8af3e">EMV_CTLS_ContinueOnline</a>(...);</div>
<div class="line">          }</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___t_e_c___r_e_t_u_r_n___c_o_d_e_s.html#gae1d5a1303c3edd9aa78e9ed9b8c3207a">CTS_TIMEOUT</a>: <span class="comment">// no technology detected</span></div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___t_e_c___r_e_t_u_r_n___c_o_d_e_s.html#ga7cc5cc3d019136c0a8942e62c558b69c">CTS_STOPPED</a>: <span class="comment">// technology selection aborted</span></div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>: <span class="comment">// error (see cts_WaitSelection() for details about all possible return values)</span></div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">else</span></div>
<div class="line">{</div>
<div class="line">  <a class="code" href="group___f_u_n_c___f_l_o_w.html#ga2b4820be53959b56fb7f672bd54f4e63">EMV_CTLS_Break</a>();</div>
<div class="line">}</div>
<div class="line">....</div>
</div><!-- fragment --><h2><a class="anchor" id="sec_tec_sample2"></a>
Sample2: Application using ADK-TEC with callback</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;pthread.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="tec_8h.html">tec/tec.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;msr/msr.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_e_m_v___c_t___interface_8h.html">EMV_CT_Interface.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_e_m_v___c_t_l_s___interface_8h.html">EMV_CTLS_Interface.h</a>&quot;</span></div>
<div class="line">....</div>
<div class="line"><span class="keyword">static</span> pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;</div>
<div class="line"><span class="keyword">static</span> pthread_cond_t condition = PTHREAD_COND_INITIALIZER;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span>  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> technology;</div>
<div class="line"><span class="keyword">static</span>  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> data[100];</div>
<div class="line"><span class="keyword">static</span>  <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> data_len = <span class="keyword">sizeof</span>(data);</div>
<div class="line"><span class="keyword">static</span>  <span class="keywordtype">int</span> ret;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> tecselCallback(<span class="keywordtype">void</span> *data)</div>
<div class="line">{</div>
<div class="line">  pthread_mutex_lock(&amp;mutex);</div>
<div class="line">  ret = <a class="code" href="tec_8h.html#aee5b104d8ad6e85feddb685379cdbf0c">cts_WaitSelection</a>(&amp;technology, data, data_len, 0)</div>
<div class="line">  pthread_cond_signal(&amp;condition);</div>
<div class="line">  pthread_mutex_unlock(&amp;mutex);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">....</div>
<div class="line"> </div>
<div class="line">a) MSR, CT, CTLS EMV only</div>
<div class="line"><span class="comment">// initialize:</span></div>
<div class="line">EMV_CT_InitFramework(...);</div>
<div class="line">EMV_CTLS_InitFramework(...);</div>
<div class="line"><span class="comment">// setup transaction</span></div>
<div class="line"><a class="code" href="group___f_u_n_c___f_l_o_w.html#ga1a86c76dcf8fec6e97ead6cf8f2717ff">EMV_CTLS_SetupTransaction</a>(...);</div>
<div class="line"><span class="comment">// start technology selection with callback:</span></div>
<div class="line"><a class="code" href="_v_h_q__vfisyspm__wrapper_8cpp.html#a70aa738d3c50b0bbed156ee52c84679d">if</a> (<a class="code" href="tec_8h.html#ac6699fe32fc23e90713eb617e9ff25e7">cts_StartSelection</a>(<a class="code" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gadbc63cc59da76fff7974cd5631f56662">CTS_CHIP</a>|<a class="code" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#ga56e64c2a97c61e8cb043de2852986a3a">CTS_CTLS</a>|<a class="code" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a>, 10, &amp;tecselCallback, NULL, NULL, 0) == <a class="code" href="group___t_e_c___r_e_t_u_r_n___c_o_d_e_s.html#ga1952f713ce2bbfa1d8b54142ca52ecc4">CTS_OK</a>)</div>
<div class="line"> </div>
<div class="line">b) MSR, CT, CTLS EMV + WALLET (Remark: NFC ADK supports EITHER VAS processing OR PassTrough processing, mutual exclusive)</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> options[2] = {0};</div>
<div class="line"><span class="comment">// initialize:</span></div>
<div class="line">EMV_CT_InitFramework(...);</div>
<div class="line">EMV_CTLS_InitFramework(...);</div>
<div class="line"><a class="code" href="sdi__nfc_8h.html#a7a9419cd6aa7aa9185fb249ce761ae0f">NFC_Client_Init</a>(...);</div>
<div class="line"><a class="code" href="titusstubs_8cpp.html#ad0a349a0904d698fea9fffa004cb3eb3">NFC_Terminal_Config</a>(...);</div>
<div class="line"><a class="code" href="titusstubs_8cpp.html#a8816583d91da702a6c7e2143ed68f7d9">NFC_VAS_UpdateConfig</a>(...);</div>
<div class="line"><a class="code" href="tec_8h.html#aa237be1f0249503d0b959d3800f1ee34">cts_SetOptions</a>(...); <span class="comment">// to set VAS appID</span></div>
<div class="line"><span class="comment">// setup transaction:</span></div>
<div class="line"><a class="code" href="group___f_u_n_c___f_l_o_w.html#ga1a86c76dcf8fec6e97ead6cf8f2717ff">EMV_CTLS_SetupTransaction</a>(...);</div>
<div class="line"><a class="code" href="titusstubs_8cpp.html#a8ee28a30cc5757bdd4d9ac413fe7ef17">NFC_VAS_PreLoad</a>(...);</div>
<div class="line">options[1] = <a class="code" href="group___t_e_c___s_t_a_r_t___o_p_t_i_o_n_s.html#ga4678a7752f0337b236971dcd370edf93">CTS_VAS_ENABLE</a>;</div>
<div class="line"><span class="comment">// start technology selection with callback:</span></div>
<div class="line"><span class="keywordflow">if</span> (<a class="code" href="tec_8h.html#ac6699fe32fc23e90713eb617e9ff25e7">cts_StartSelection</a>(<a class="code" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gadbc63cc59da76fff7974cd5631f56662">CTS_CHIP</a>|<a class="code" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#ga56e64c2a97c61e8cb043de2852986a3a">CTS_CTLS</a>|<a class="code" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a>, 10, &amp;tecselCallback, NULL, options, 2) == <a class="code" href="group___t_e_c___r_e_t_u_r_n___c_o_d_e_s.html#ga1952f713ce2bbfa1d8b54142ca52ecc4">CTS_OK</a>)</div>
<div class="line"> </div>
<div class="line">c) MSR, CT, CTLS EMV + NFC Pass Through (Remark: NFC ADK supports EITHER VAS processing OR PassTrough processing, mutual exclusive)</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> options[16] = {0};</div>
<div class="line"><span class="comment">// initialize:</span></div>
<div class="line">EMV_CT_InitFramework(...);</div>
<div class="line">EMV_CTLS_InitFramework(...);</div>
<div class="line"><a class="code" href="sdi__nfc_8h.html#a7a9419cd6aa7aa9185fb249ce761ae0f">NFC_Client_Init</a>(...);</div>
<div class="line"><span class="comment">// setup transaction:</span></div>
<div class="line"><a class="code" href="group___f_u_n_c___f_l_o_w.html#ga1a86c76dcf8fec6e97ead6cf8f2717ff">EMV_CTLS_SetupTransaction</a>(...);</div>
<div class="line">options[1] = <a class="code" href="group___t_e_c___s_t_a_r_t___o_p_t_i_o_n_s.html#gaafe9099680a56edd52a1258a797efa07">CTS_NFC_ENABLE</a>;</div>
<div class="line">options[1] |= <a class="code" href="group___t_e_c___s_t_a_r_t___o_p_t_i_o_n_s.html#ga16d617787fe23f80aae81a4c3bc944bf">CTS_EMV_AFTER_NFC_ISO</a>; <span class="comment">// optional</span></div>
<div class="line">options[15] = 0x0F; <span class="comment">// select card types</span></div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line"><span class="comment">// start technology selection with callback:</span></div>
<div class="line"><span class="keywordflow">if</span> (<a class="code" href="tec_8h.html#ac6699fe32fc23e90713eb617e9ff25e7">cts_StartSelection</a>(<a class="code" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gadbc63cc59da76fff7974cd5631f56662">CTS_CHIP</a>|<a class="code" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#ga56e64c2a97c61e8cb043de2852986a3a">CTS_CTLS</a>|<a class="code" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a>, 10, &amp;tecselCallback, NULL, options, 16) == <a class="code" href="group___t_e_c___r_e_t_u_r_n___c_o_d_e_s.html#ga1952f713ce2bbfa1d8b54142ca52ecc4">CTS_OK</a>)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> tlv_response = <span class="keyword">false</span>;</div>
<div class="line">  </div>
<div class="line">  pthread_mutex_lock(&amp;mutex);</div>
<div class="line">  <span class="comment">// wait for callback:</span></div>
<div class="line">  pthread_cond_wait(&amp;condition, &amp;mutex);</div>
<div class="line">  pthread_mutex_unlock(&amp;mutex);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">switch</span> (ret)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___t_e_c___r_e_t_u_r_n___c_o_d_e_s.html#ga1952f713ce2bbfa1d8b54142ca52ecc4">CTS_OK</a>: <span class="comment">// technology detected</span></div>
<div class="line">      </div>
<div class="line">      <span class="keywordflow">if</span>(technology &amp; <a class="code" href="tec__common_8h.html#a56386219739d173835a83194608fedea">CTS_DATA_TLV</a>)</div>
<div class="line">      {</div>
<div class="line">        <span class="comment">// clear TLV response flag</span></div>
<div class="line">        technology &amp;= ~<a class="code" href="tec__common_8h.html#a56386219739d173835a83194608fedea">CTS_DATA_TLV</a>;</div>
<div class="line">        tlv_response = <span class="keyword">true</span>;</div>
<div class="line">      }</div>
<div class="line">      </div>
<div class="line">      <span class="keywordflow">switch</span> (technology)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a>:</div>
<div class="line">          <a class="code" href="msr_8h.html#ad00fdde838f486d43be689650ab58d43">MSR_GetData</a>(...);</div>
<div class="line">          <a class="code" href="msr_8h.html#aac28b2c3771f8221fc26a35f0fd6d0f8">MSR_Deactivate</a>(...);</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gadbc63cc59da76fff7974cd5631f56662">CTS_CHIP</a>:</div>
<div class="line">          <a class="code" href="group___f_u_n_c___f_l_o_w.html#ga8be6df6babc587a19f63f284b2a6f006">EMV_CT_ContinueOffline</a>(...);</div>
<div class="line">          <a class="code" href="group___f_u_n_c___f_l_o_w.html#ga42f570d2b8e66841ab9e8de7736e92d4">EMV_CT_ContinueOnline</a>(...);</div>
<div class="line">          <span class="comment">// wait for removal of chip card</span></div>
<div class="line">          <a class="code" href="tec_8h.html#a92ab7780df1f8150c6d8a9b3ab3163bf">cts_WaitCardRemoval2</a>(10);</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#ga56e64c2a97c61e8cb043de2852986a3a">CTS_CTLS</a>:</div>
<div class="line">          <span class="keywordflow">if</span> (tlv_response)</div>
<div class="line">          {</div>
<div class="line">            <span class="comment">// Evaluate the response tags for NFC Pass Through, NFC VAS processing, and EMV processing if configured in b) or c) above. </span></div>
<div class="line">          }</div>
<div class="line">          <span class="keywordflow">else</span></div>
<div class="line">          {</div>
<div class="line">            <a class="code" href="group___f_u_n_c___f_l_o_w.html#gaf23f6f87fe90619810470fad7d11f321">EMV_CTLS_ContinueOffline</a>(...);</div>
<div class="line">            <a class="code" href="group___f_u_n_c___f_l_o_w.html#ga297b6843994afaa2e7a6f5e0e4a8af3e">EMV_CTLS_ContinueOnline</a>(...);</div>
<div class="line">          }</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___t_e_c___r_e_t_u_r_n___c_o_d_e_s.html#gae1d5a1303c3edd9aa78e9ed9b8c3207a">CTS_TIMEOUT</a>: <span class="comment">// no technology detected</span></div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___t_e_c___r_e_t_u_r_n___c_o_d_e_s.html#ga7cc5cc3d019136c0a8942e62c558b69c">CTS_STOPPED</a>: <span class="comment">// technology selection aborted</span></div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>: <span class="comment">// error (see cts_WaitSelection() for details about all possible return values)</span></div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">else</span></div>
<div class="line">{</div>
<div class="line">  <a class="code" href="group___f_u_n_c___f_l_o_w.html#ga2b4820be53959b56fb7f672bd54f4e63">EMV_CTLS_Break</a>();</div>
<div class="line">}</div>
<div class="line">....</div>
</div><!-- fragment --><p>Link your application with libtec.so and load the shared library libtec.so on your device. If you don't want to periodically call <a class="el" href="tec_8h.html#aee5b104d8ad6e85feddb685379cdbf0c">cts_WaitSelection()</a> you can supply a callback function to <a class="el" href="tec_8h.html#ac6699fe32fc23e90713eb617e9ff25e7">cts_StartSelection()</a>. This callback function is called exactly once after the technology selection has finished (due to detected technology, timeout, or error). After this callback function has been called (or even withing the callback function) you can obtain the result by <a class="el" href="tec_8h.html#aee5b104d8ad6e85feddb685379cdbf0c">cts_WaitSelection()</a> setting its timeout to 0. A callback function is supported for card removal detection as well (see <a class="el" href="tec_8h.html#a8db288b6803c1fba534d94a99f1b646b">cts_WaitCardRemoval()</a>).</p>
<h1><a class="anchor" id="sec_tec_programming"></a>
Programming</h1>
<h2><a class="anchor" id="subsec_tec_programming_and_api_principles"></a>
Programming and API Principles</h2>
<p>The API consists of the following functions:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone"><a class="el" href="tec_8h.html">tec.h</a>  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="tec__common_8h.html#a68272ed65703130d4858d9c28c21f9b9">cts_Version()</a>  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="tec__common_8h.html#a90770d44c55c14fa472396c74fec6052">cts_SetTraceCallback()</a>  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="tec_8h.html#aa237be1f0249503d0b959d3800f1ee34">cts_SetOptions()</a>  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="tec_8h.html#ac6699fe32fc23e90713eb617e9ff25e7">cts_StartSelection()</a>  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="tec_8h.html#acaf2d75d1b584ae97ff9ee4da47cee38">cts_StopSelection()</a>  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="tec_8h.html#aee5b104d8ad6e85feddb685379cdbf0c">cts_WaitSelection()</a>  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="tec_8h.html#a8569782d27f43e5d88cef3575a5d12c6">cts_RemoveTechnologies()</a>  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="tec_8h.html#aa60922ab5b40a033ac85a36e8022cafa">cts_AddTechnologies()</a>  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="tec_8h.html#a8db288b6803c1fba534d94a99f1b646b">cts_WaitCardRemoval()</a>  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="tec_8h.html#a92ab7780df1f8150c6d8a9b3ab3163bf">cts_WaitCardRemoval2()</a>  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="tec_2export_2tec_2ped_8h.html#aa093da583e918cfb6dd8e152c39af3bc">ped_SetSendRcvCb()</a>  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="tec_2export_2tec_2ped_8h.html#a124ea72634b37bdf5d09ce5e0869ca55">ped_Pairing()</a>  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="tec_2export_2tec_2ped_8h.html#ab4792fd3cacefd42f8f7bf365e779484">ped_MovePin()</a>  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="tec_8h.html#ada083dc0f484d99ab24df79ed5f145c9">cts_SetNotificationCallback()</a>  </td></tr>
</table>
<h3><a class="anchor" id="subsubsec_tec_technology_notes"></a>
Some notes regarding the different technologies</h3>
<p>In general only one of <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a>, <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gadbc63cc59da76fff7974cd5631f56662">CTS_CHIP</a>, <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#ga56e64c2a97c61e8cb043de2852986a3a">CTS_CTLS</a> is detected but in special cases (see <a class="el" href="pg_tec_programmers_guide.html#subsubsec_tec_msr_after_ctls">Detecting MSR and CTLS simultaneously</a> and <a class="el" href="pg_tec_programmers_guide.html#subsubsec_tec_special_ux_handling">Special behavior on hybrid readers (UX30x)</a>) two technologies can be detected at once.</p>
<ul>
<li><a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a>: If you want to use the magnetic card reader, you do not need to call <a class="el" href="msr_8h.html#a1e92fd29720fecbf50da24a30c7b512f">MSR_Activate()</a> before starting technology selection. ADK-TEC will do this for you. After technology selection finishes and the detected technology is not <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a>, <a class="el" href="msr_8h.html#aac28b2c3771f8221fc26a35f0fd6d0f8">MSR_Deactivate()</a> is internally called as well. So you do not need to do this either. Only if the detected technology is <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a>, ADK-MSR is still activated to allow the application to fetch the magnetic card data with <a class="el" href="msr_8h.html#ad00fdde838f486d43be689650ab58d43">MSR_GetData()</a>. After this you shall call <a class="el" href="msr_8h.html#aac28b2c3771f8221fc26a35f0fd6d0f8">MSR_Deactivate()</a>. If using an UX device <a class="el" href="msr_8h.html#aac28b2c3771f8221fc26a35f0fd6d0f8">MSR_Deactivate()</a> shall be called as well if technology selection detects <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gadbc63cc59da76fff7974cd5631f56662">CTS_CHIP</a> or returns <a class="el" href="group___t_e_c___r_e_t_u_r_n___c_o_d_e_s.html#ga058dc7a7d6d6562dac8171ca86f5b5c0">CTS_NO_CHIP</a> (see <a class="el" href="pg_tec_programmers_guide.html#subsubsec_tec_special_ux_handling">Special behavior on hybrid readers (UX30x)</a>).</li>
<li><a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gadbc63cc59da76fff7974cd5631f56662">CTS_CHIP</a>: If you want to use the chip card reader, you should first call EMV_CT_InitFramework() to enable the contact part of ADK-EMV. After technology selection detects a chip card the card is already powered up (except if you set option <a class="el" href="group___t_e_c___s_t_a_r_t___o_p_t_i_o_n_s.html#ga1073825ee49c63471bef39392d6df7e6">CTS_NO_POWERON</a>) and the application can call <a class="el" href="group___f_u_n_c___f_l_o_w.html#ga8be6df6babc587a19f63f284b2a6f006" title="EMV transaction (offline part including 1st cryptogram)">EMV_CT_ContinueOffline()</a>.</li>
<li><a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#ga56e64c2a97c61e8cb043de2852986a3a">CTS_CTLS</a>: (EMV only, see below for NFC)<ul>
<li>Card detection only (option <a class="el" href="group___t_e_c___s_t_a_r_t___o_p_t_i_o_n_s.html#gaeff0a0e1b335597ea1ec0781f15edb08">CTS_PURE_CARD_DETECTION</a>) <br  />
 ADK-TEC activates the card by means of <a class="el" href="group___f_u_n_c___i_c_c.html#gae2c93f30f24ceb94c930a7cae2b36116" title="Detect if card is present in the RF field (read ATR)">EMV_CTLS_SmartReset()</a>. <br  />
 So calling application can continue to work with the card by <a class="el" href="group___f_u_n_c___i_c_c.html#gafbcdb0278723b9629eb7c12532119e2d" title="Send chip card command and receive response.">EMV_CTLS_SmartISO()</a>. <br  />
 And finally it shall call <a class="el" href="group___f_u_n_c___i_c_c.html#gadd0716253a50b2791ac4e2a1627d1e8d" title="Deactivate chip card.">EMV_CTLS_SmartPowerOff()</a> to switch off the RF field. <br  />
 In case an EMV transaction is desired the <a class="el" href="group___f_u_n_c___i_c_c.html#gadd0716253a50b2791ac4e2a1627d1e8d" title="Deactivate chip card.">EMV_CTLS_SmartPowerOff()</a> has to be called. <br  />
 And then <a class="el" href="group___f_u_n_c___f_l_o_w.html#ga1a86c76dcf8fec6e97ead6cf8f2717ff" title="Set up a CTLS EMV transaction.">EMV_CTLS_SetupTransaction()</a> and <a class="el" href="group___f_u_n_c___f_l_o_w.html#gaf23f6f87fe90619810470fad7d11f321" title="CTLS EMV transaction (offline part ... including 1st cryptogram, depends on CTLS scheme)">EMV_CTLS_ContinueOffline()</a>.</li>
<li>EMV transaction <br  />
 First call EMV_CTLS_InitFramework() and prior to each technology selection you have to call <a class="el" href="group___f_u_n_c___f_l_o_w.html#ga1a86c76dcf8fec6e97ead6cf8f2717ff" title="Set up a CTLS EMV transaction.">EMV_CTLS_SetupTransaction()</a>. <br  />
 ADK-TEC will internally call <a class="el" href="group___f_u_n_c___f_l_o_w.html#gaf23f6f87fe90619810470fad7d11f321" title="CTLS EMV transaction (offline part ... including 1st cryptogram, depends on CTLS scheme)">EMV_CTLS_ContinueOffline()</a> to detect the card and perform the transaction. <br  />
 If a contactless card is detected, the application can call <a class="el" href="group___f_u_n_c___f_l_o_w.html#gaf23f6f87fe90619810470fad7d11f321" title="CTLS EMV transaction (offline part ... including 1st cryptogram, depends on CTLS scheme)">EMV_CTLS_ContinueOffline()</a> again to obtain the transaction results. <br  />
 If no contactless card is detected, ADK-TEC internally calls <a class="el" href="group___f_u_n_c___f_l_o_w.html#ga2b4820be53959b56fb7f672bd54f4e63" title="Universal break command    Velocity: Only required when using EMV_CTLS_START_STRUCT::ServerPollTimeou...">EMV_CTLS_Break()</a>. <br  />
 One additional remark regarding <a class="el" href="group___f_u_n_c___f_l_o_w.html#ga1a86c76dcf8fec6e97ead6cf8f2717ff" title="Set up a CTLS EMV transaction.">EMV_CTLS_SetupTransaction()</a>: If ADK-TEC is used, you must not set parameter ServerPollTimeout because in this case ADK-TEC takes care of polling.</li>
</ul>
</li>
</ul>
<h3><a class="anchor" id="subsubsec_tec_nfc_notes"></a>
Processing NFC with ADK-TEC</h3>
<p>This is the general routine used in ADK-TEC for detecting and processing CTLS cards (pseudocode), it should help you to understand how ADK-TEC behaves depending on the various CTLS options. </p><div class="fragment"><div class="line">[0] if both CTS_NFC_ENABLE and CTS_VAS_ENABLE are set:</div>
<div class="line">        exit</div>
<div class="line">    end</div>
<div class="line">[1] if CTS_NFC_ENABLE is set:</div>
<div class="line">        call NFC_PT_Polling()</div>
<div class="line">        if ISO A/B card found and CTS_EMV_AFTER_NFC_ISO is set:</div>
<div class="line">            goto [3]</div>
<div class="line">        end</div>
<div class="line">        exit</div>
<div class="line">    end</div>
<div class="line">[2] if CTS_VAS_ENABLE is set:</div>
<div class="line">        call NFC_VAS_Activate()</div>
<div class="line">        if VAS_DO_PAY is returned:</div>
<div class="line">            goto [3]</div>
<div class="line">        end</div>
<div class="line">        exit</div>
<div class="line">    end</div>
<div class="line">[3] if CTS_PURE_CARD_DETECTION is set:</div>
<div class="line">        call EMV_CTLS_SmartReset()</div>
<div class="line">    else</div>
<div class="line">        call EMV_CTLS_ContinueOffline()</div>
<div class="line">    end</div>
</div><!-- fragment --><p> If it is possible that <a class="el" href="group___f_u_n_c___f_l_o_w.html#gaf23f6f87fe90619810470fad7d11f321" title="CTLS EMV transaction (offline part ... including 1st cryptogram, depends on CTLS scheme)">EMV_CTLS_ContinueOffline()</a> is called by ADK-TEC, application has to call <a class="el" href="group___f_u_n_c___f_l_o_w.html#ga1a86c76dcf8fec6e97ead6cf8f2717ff" title="Set up a CTLS EMV transaction.">EMV_CTLS_SetupTransaction()</a> before starting technology selection. If ADK-TEC detects a card with <a class="el" href="titusstubs_8cpp.html#aa1e541259f194621834060bf770b717b">NFC_PT_Polling()</a> and no subsequent EMV transaction is started, ADK-TEC keeps the RF field on to allow the application to communicate with this card. In this case the application has to call <a class="el" href="titusstubs_8cpp.html#a65c5ac372de4d71a8154f61b820abaf0">NFC_PT_FieldOff()</a> and <a class="el" href="titusstubs_8cpp.html#a00d4921f4a21667ae4cddb317ffc04a5">NFC_PT_Close()</a> afterwards. Furthermore the first CTLS LED is left on by ADK-TEC in this case. The application generally wants it to shine while communicating with the card or even wants to switch on further LEDs. So as soon as the application has finished the transaction, it needs to switch off the LEDs or restart idle blinking. </p>
<h3><a class="anchor" id="subsubsec_tec_msr_after_ctls"></a>
Detecting MSR and CTLS simultaneously</h3>
<p>After <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#ga56e64c2a97c61e8cb043de2852986a3a">CTS_CTLS</a> has been detected technology selection can wait a certain amount of time for <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a> before returning the result to the application. If a magnetic card is swiped within this period of time technology selection will return <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#ga56e64c2a97c61e8cb043de2852986a3a">CTS_CTLS</a>|<a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a> as technology. The timeout can be configured by the options parameter of <a class="el" href="tec_8h.html#ac6699fe32fc23e90713eb617e9ff25e7">cts_StartSelection()</a>.</p>
<h3><a class="anchor" id="subsubsec_tec_special_ux_handling"></a>
Special behavior on hybrid readers (UX30x)</h3>
<p>Hybrid readers have a single slot for handling magstripe and contact chip. <br  />
 ADK-TEC provides special functionality to help the application in making the decision which technology to choose.</p>
<p><u><b>ADK-MSR Configuration</b></u></p>
<p>When using an UX30x device it is strongly recommended to activate the MSR UX enhancements (see <a href="./pg_msr_programmers_guide.html" title="ADK-MSR Programmers Guide">ADK-MSR Programmers Guide</a>): </p><div class="fragment"><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> options[] = { <a class="code" href="group___m_s_r___o_p_t_i_o_n_s___b_i_t_m_a_s_k.html#ga2a413b4af9749ddf671d95422930aa38">MSR_UX_ENHANCEMENTS</a> };</div>
<div class="line"><a class="code" href="msr_8h.html#ac3c6f568aa57690a8b369936fc362c2a">MSR_SetOptions</a>(options, <span class="keyword">sizeof</span>(options));</div>
</div><!-- fragment --><p> This has to be done only once, before the first call of <a class="el" href="tec_8h.html#ac6699fe32fc23e90713eb617e9ff25e7">cts_StartSelection()</a>. These enhancements will prevent MSR from reading the magnetic card on insertion.</p>
<p>If the MSR UX enhancements are not activated, the following remarks are valid as well. Additionally it is possible that technology selection detects both <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a> and <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gadbc63cc59da76fff7974cd5631f56662">CTS_CHIP</a> in parallel.</p>
<p><u><b>Use Case: Technologies Contact Chip and Magstripe are supported</b></u></p>
<p><a class="el" href="tec_8h.html#ac6699fe32fc23e90713eb617e9ff25e7">cts_StartSelection()</a> is called with requesting technology <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gadbc63cc59da76fff7974cd5631f56662">CTS_CHIP</a> (and <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a>). <br  />
 <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#ga56e64c2a97c61e8cb043de2852986a3a">CTS_CTLS</a> may or may not be activated.</p>
<div class="image">
<img src="HybridReader-MSR-CT.png" alt=""/>
</div>
<p><u><b>Use Case: Technology Magstripe supported but Contact Chip NOT</b></u></p>
<p><a class="el" href="tec_8h.html#ac6699fe32fc23e90713eb617e9ff25e7">cts_StartSelection()</a> is called with requesting technology <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gadbc63cc59da76fff7974cd5631f56662">CTS_CHIP</a> (and <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a>). <br  />
 <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gadbc63cc59da76fff7974cd5631f56662">CTS_CHIP</a> is necessary to be able to detect the card insertion. <br  />
 <a class="el" href="group___t_e_c___s_t_a_r_t___o_p_t_i_o_n_s.html#ga1073825ee49c63471bef39392d6df7e6">CTS_NO_POWERON</a> shall be set to avoid activation of chip card. <br  />
 <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#ga56e64c2a97c61e8cb043de2852986a3a">CTS_CTLS</a> may or may not be activated.</p>
<div class="image">
<img src="HybridReader-MSR-only.png" alt=""/>
</div>
<p><u><b>ADK-TEC legacy timeout handling</b></u></p>
<p>Above shown diagrams are recommended handling. <br  />
 For downward compatibility the following functionality is still supported.</p>
<ul>
<li><b>Let ADK-TEC wait for MSR data read on card removal</b> <br  />
 This scenario assumes that technologies <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gadbc63cc59da76fff7974cd5631f56662">CTS_CHIP</a> and <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a> are supported. <br  />
 The application may set a timeout to <a class="el" href="tec_8h.html#ac6699fe32fc23e90713eb617e9ff25e7">cts_StartSelection()</a> (options[8..9]). <br  />
 Technology selection waits for this amount of time for MSR data from card removal. <br  />
 This functionality is not possible when using <a class="el" href="group___t_e_c___s_t_a_r_t___o_p_t_i_o_n_s.html#ga1073825ee49c63471bef39392d6df7e6">CTS_NO_POWERON</a> (so not for SDI and vos3)<ul>
<li>If a <b>chip card</b> is inserted it goes the same way as usual: <br  />
 <a class="el" href="tec_8h.html#aee5b104d8ad6e85feddb685379cdbf0c">cts_WaitSelection()</a> returns <a class="el" href="group___t_e_c___r_e_t_u_r_n___c_o_d_e_s.html#ga1952f713ce2bbfa1d8b54142ca52ecc4">CTS_OK</a> and usedTechnology <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gadbc63cc59da76fff7974cd5631f56662">CTS_CHIP</a> <br  />
 The application shall use <a class="el" href="group___f_u_n_c___f_l_o_w.html#gac13472c2a4aea6475fe7bb52627e97eb" title="EMV Application Selection.">EMV_CT_StartTransaction()</a> etc. to process an EMV contact transaction.</li>
<li>If a <b>card without chip</b> is inserted <br  />
 ADK-TEC waits for the above mentioned timeout for card removal (and reading magstripe data)<ul>
<li>If there is MSR data <br  />
 <a class="el" href="tec_8h.html#aee5b104d8ad6e85feddb685379cdbf0c">cts_WaitSelection()</a> returns <a class="el" href="group___t_e_c___r_e_t_u_r_n___c_o_d_e_s.html#ga1952f713ce2bbfa1d8b54142ca52ecc4">CTS_OK</a> and usedTechnology <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a> <br  />
 Application shall<ul>
<li>call <a class="el" href="msr_8h.html#ad00fdde838f486d43be689650ab58d43">MSR_GetData()</a> to obtain the MSR data</li>
<li>call <a class="el" href="msr_8h.html#aac28b2c3771f8221fc26a35f0fd6d0f8">MSR_Deactivate()</a></li>
</ul>
</li>
<li>if not <br  />
 <a class="el" href="tec_8h.html#aee5b104d8ad6e85feddb685379cdbf0c">cts_WaitSelection()</a> returns <a class="el" href="group___t_e_c___r_e_t_u_r_n___c_o_d_e_s.html#ga058dc7a7d6d6562dac8171ca86f5b5c0">CTS_NO_CHIP</a> and usedTechnology 0. <br  />
 In that case application<ul>
<li>may<ul>
<li>check if card is still inserted, if yes:</li>
<li>ask the cardholder to remove the card</li>
<li>wait for MSR data by polling <a class="el" href="msr_8h.html#a8096fa193f035eb4b80673260d720477">MSR_DataAvailable()</a></li>
<li>call <a class="el" href="msr_8h.html#ad00fdde838f486d43be689650ab58d43">MSR_GetData()</a> to obtain the MSR data</li>
</ul>
</li>
<li>must (in any case)<ul>
<li>call <a class="el" href="msr_8h.html#aac28b2c3771f8221fc26a35f0fd6d0f8">MSR_Deactivate()</a> <br  />
 <br  />
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><b>Let ADK-TEC notify on card insertion</b> <br  />
 Detect card insertion, inform application about this event and wait for MSR data read on card removal. <br  />
 <a class="el" href="tec_8h.html#ac6699fe32fc23e90713eb617e9ff25e7">cts_StartSelection()</a> is called WITHOUT requesting technology <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gadbc63cc59da76fff7974cd5631f56662">CTS_CHIP</a> <br  />
 <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#ga56e64c2a97c61e8cb043de2852986a3a">CTS_CTLS</a> may or may not be activated. <br  />
 <br  />
<ul>
<li><b>Card insertion notification callback</b> <br  />
 <a class="el" href="tec_8h.html#ada083dc0f484d99ab24df79ed5f145c9">cts_SetNotificationCallback()</a> can be used to register the callback <a class="el" href="group___t_e_c___n_o_t_i_f_i_c_a_t_i_o_n___c_b_k___t_y_p_e.html#ga131e9251b6b4f9c9c7a187c07f12820a">CTS_NOTIFICATION_CBK_TYPE_UX_CARD_INSERTED</a> <br  />
 That's invoked in case a card is inserted. <br  />
 This functionality may be used to realize a cardholder display "please remove card". <br  />
 It's only available in case one of the below mentioned timeouts is set. <br  />
 <br  />
</li>
<li><b>Card Insertion Timeout</b> <br  />
 The application may set a <b>timeout</b> to <a class="el" href="tec_8h.html#ac6699fe32fc23e90713eb617e9ff25e7">cts_StartSelection()</a> (options[8..9]). <br  />
 After card insertion the ADK-TEC waits for this amount of time for MSR data (from card removal).<ul>
<li>If there is MSR data <br  />
 <a class="el" href="tec_8h.html#aee5b104d8ad6e85feddb685379cdbf0c">cts_WaitSelection()</a> returns <a class="el" href="group___t_e_c___r_e_t_u_r_n___c_o_d_e_s.html#ga1952f713ce2bbfa1d8b54142ca52ecc4">CTS_OK</a> and usedTechnology <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a> <br  />
 Application shall<ul>
<li>call <a class="el" href="msr_8h.html#ad00fdde838f486d43be689650ab58d43">MSR_GetData()</a> to obtain the MSR data</li>
<li>call <a class="el" href="msr_8h.html#aac28b2c3771f8221fc26a35f0fd6d0f8">MSR_Deactivate()</a></li>
</ul>
</li>
<li>if not <br  />
 <a class="el" href="tec_8h.html#aee5b104d8ad6e85feddb685379cdbf0c">cts_WaitSelection()</a> returns <a class="el" href="group___t_e_c___r_e_t_u_r_n___c_o_d_e_s.html#ga058dc7a7d6d6562dac8171ca86f5b5c0">CTS_NO_CHIP</a> and usedTechnology 0. <br  />
 In that case application<ul>
<li>may<ul>
<li>check if card is still inserted, if yes:</li>
<li>ask the cardholder to remove the card</li>
<li>wait for MSR data by polling <a class="el" href="msr_8h.html#a8096fa193f035eb4b80673260d720477">MSR_DataAvailable()</a></li>
<li>call <a class="el" href="msr_8h.html#ad00fdde838f486d43be689650ab58d43">MSR_GetData()</a> to obtain the MSR data</li>
</ul>
</li>
<li>must (in any case)<ul>
<li>call <a class="el" href="msr_8h.html#aac28b2c3771f8221fc26a35f0fd6d0f8">MSR_Deactivate()</a> <br  />
 <br  />
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><b>Card Removal Timeout</b> <br  />
 Avoid long delay after card removal in case used card does not have a magstripe.<ul>
<li>By means of <a class="el" href="tec_8h.html#aa237be1f0249503d0b959d3800f1ee34">cts_SetOptions()</a> the <a class="el" href="group___t_e_c___o_p_t_i_o_n___t_a_g_s.html#gac87bf22ae5667cc2b22f86aad8218ce5">CTS_OPTION_TAG_UX_MSR_TIMEOUT</a> can be set.</li>
<li>It's only effective in case the above mentioned timeout (<a class="el" href="tec_8h.html#ac6699fe32fc23e90713eb617e9ff25e7">cts_StartSelection()</a> options[8..9]) is deactivated.</li>
<li>Timeout is started after card removal.</li>
<li>If MSR data is read (before timeout expiry) <br  />
 <a class="el" href="tec_8h.html#aee5b104d8ad6e85feddb685379cdbf0c">cts_WaitSelection()</a> returns <a class="el" href="group___t_e_c___r_e_t_u_r_n___c_o_d_e_s.html#ga1952f713ce2bbfa1d8b54142ca52ecc4">CTS_OK</a> and usedTechnology <a class="el" href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a> <br  />
 Application shall<ul>
<li>call <a class="el" href="msr_8h.html#ad00fdde838f486d43be689650ab58d43">MSR_GetData()</a> to obtain the MSR data</li>
<li>call <a class="el" href="msr_8h.html#aac28b2c3771f8221fc26a35f0fd6d0f8">MSR_Deactivate()</a></li>
</ul>
</li>
<li>If not (timeout expiration) <br  />
 <a class="el" href="tec_8h.html#aee5b104d8ad6e85feddb685379cdbf0c">cts_WaitSelection()</a> returns <a class="el" href="group___t_e_c___r_e_t_u_r_n___c_o_d_e_s.html#gadf0a2a2d0df56c222253a27bfeefdbb7">CTS_UX_MSRDATA_NOT_AVAILABLE_TIMEOUT</a> and usedTechnology 0 <br  />
 In that case application<ul>
<li>may<ul>
<li>check if card is still inserted, if yes:</li>
<li>ask the cardholder to remove the card</li>
<li>wait for MSR data by polling <a class="el" href="msr_8h.html#a8096fa193f035eb4b80673260d720477">MSR_DataAvailable()</a></li>
<li>call <a class="el" href="msr_8h.html#ad00fdde838f486d43be689650ab58d43">MSR_GetData()</a> to obtain the MSR data</li>
</ul>
</li>
<li>must (in any case)<ul>
<li>call <a class="el" href="msr_8h.html#aac28b2c3771f8221fc26a35f0fd6d0f8">MSR_Deactivate()</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="sec_tec_system_setup_and_requirements"></a>
System Setup and Requirements</h1>
<h2><a class="anchor" id="subsec_tec_compiler_and_linker_settings"></a>
Compiler and Linker Settings</h2>
<p>include <a class="el" href="tec_8h.html">tec.h</a> and link libtec.so <br  />
 libtec defines it's dependencies to other libs in needed section (you can show that by <code>"objdump -p libtec | grep NEEDED"</code>)</p>
<h2><a class="anchor" id="subsec_tec_hardware"></a>
Hardware</h2>
<p>ADK-TEC is hardware platform agnostic and supports installation on V/OS and VOS2 terminals.</p>
<h2><a class="anchor" id="subsec_tec_software"></a>
Software</h2>
<p>ADK-TEC is designed to be platform agnostic and will be supported on V/OS and VOS2 terminal operating systems.</p>
<h2><a class="anchor" id="subsec_tec_deliverables_and_deployment"></a>
Deliverables and Deployment</h2>
<p>Packages delivered (x - version number digit):</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Package name </th><th class="markdownTableHeadNone">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>tec-doc-x.x.x-xx.zip</code>  </td><td class="markdownTableBodyNone">Documentation  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>tec-vos-dev-x.x.x-xx.zip</code>  </td><td class="markdownTableBodyNone">VOS <b>development</b> package, to be installed in PC build environment  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>tec-vos2-dev-x.x.x-xx.zip</code>  </td><td class="markdownTableBodyNone">VOS2 <b>development</b> package, to be installed in PC build environment  </td></tr>
</table>
<h1><a class="anchor" id="sec_tec_pp1000"></a>
PP1000</h1>
<h2><a class="anchor" id="subsec_tec_pairing_and_pin_transfer"></a>
Pairing and PIN transfer with PP1000</h2>
<p>ADK-TEC is capable of performing pairing a countertop device (CTP) with a PP1000 device and transferring the PIN entered at the PP1000 into the vault of the countertop device. On the PP1000 you only need to install the current AQUILA version, no ADK-TEC component is running on the PP1000. The application running on the CTP needs to include the header file ped.h which is provided by ADK-TEC. Within this file the three functions <a class="el" href="tec_2export_2tec_2ped_8h.html#aa093da583e918cfb6dd8e152c39af3bc">ped_SetSendRcvCb()</a>, <a class="el" href="tec_2export_2tec_2ped_8h.html#a124ea72634b37bdf5d09ce5e0869ca55">ped_Pairing()</a>, and <a class="el" href="tec_2export_2tec_2ped_8h.html#ab4792fd3cacefd42f8f7bf365e779484">ped_MovePin()</a> are declared. If you call one of these functions you have to additionally install the library libPP1000.so on the CTP. This library is shipped together with ADK-TEC. <a class="el" href="tec_2export_2tec_2ped_8h.html#a124ea72634b37bdf5d09ce5e0869ca55">ped_Pairing()</a> pairs the two devices. The actual pairing is only to be done once. However, if one of the devices is paired with a third device in between, the devices must be repaired. <a class="el" href="tec_2export_2tec_2ped_8h.html#a124ea72634b37bdf5d09ce5e0869ca55">ped_Pairing()</a> first checks if the two devices are successfully paired and performs the pairing only if this is necessary.</p>
<p>If the pairing is successful, a PIN can be transferred from PP1000 to CTP. The function <a class="el" href="tec_2export_2tec_2ped_8h.html#ab4792fd3cacefd42f8f7bf365e779484">ped_MovePin()</a> does not collect the PIN on the PP1000, so the PIN entry must be triggered by the application. It can directly send the commands to the PP1000 or use the function pp1000_acceptPin() which is provided by libPP1000. After the PIN has been entered, the PIN can be transferred into the vault of the CTP by calling <a class="el" href="tec_2export_2tec_2ped_8h.html#ab4792fd3cacefd42f8f7bf365e779484">ped_MovePin()</a>. If this is successfully done, the application can proceed as usual, e.g. call <a class="el" href="group___f_u_n_c___f_l_o_w.html#ga895cb054c344d011e9e3c6acc4aadafe" title="Send entered (offline) PIN to chip card for verification.">EMV_CT_Send_PIN_Offline()</a> if this is an offline PIN.</p>
<p>The communication between PP1000 and CTP has to be handled on application level. Both ADK-TEC and PP1000 lib are platform independent and do not have communication built in. The application has to call either <a class="el" href="tec_2export_2tec_2ped_8h.html#aa093da583e918cfb6dd8e152c39af3bc">ped_SetSendRcvCb()</a> (provided by ADK-TEC) or pp1000_registerComs() (provided by PP1000 lib) to set functions that send and receive data to/from the PP1000. So the application can freely decide which communication method it wants to use, e.g. you may use ADK-COM or directly call OS functions.</p>
<h1><a class="anchor" id="sec_tec_troubleshooting"></a>
Troubleshooting</h1>
<h2><a class="anchor" id="subsec_tec_frequently_asked_questions"></a>
Frequently Asked Questions</h2>
<p>Q: cts_WaitSelection-&gt;timeout_msec: What is the purpose of this timeout if compare with cts_StartSelection-&gt;timeout_sec? Provide use cases.</p>
<p>A: cts_StartSelection-&gt;timeout_sec is the timeout for the whole technology selection process, e.g. 30 seconds might be reasonable value. cts_WaitSelection-&gt;timeout_msec is the timeout for the <a class="el" href="tec_8h.html#aee5b104d8ad6e85feddb685379cdbf0c">cts_WaitSelection()</a> function. It blocks and returns only if the timeout expires (in this case CTS_IN_PROGRESS is returned) or a result is available (something != CTS_IN_PROGRESS is returned). The timeout value to use here depends on your application design. If you have set a callback function to <a class="el" href="tec_8h.html#ac6699fe32fc23e90713eb617e9ff25e7">cts_StartSelection()</a>, this callback is invoked as soon as a result is available. So you have to call <a class="el" href="tec_8h.html#aee5b104d8ad6e85feddb685379cdbf0c">cts_WaitSelection()</a> exactly once after the callback is invoked, set timeout=0 (waiting makes no sense because you know that a result is available) If you do not want to use callback function you can call <a class="el" href="tec_8h.html#aee5b104d8ad6e85feddb685379cdbf0c">cts_WaitSelection()</a> with different timeout values. If you have set timeout in <a class="el" href="tec_8h.html#ac6699fe32fc23e90713eb617e9ff25e7">cts_StartSelection()</a> to 30 seconds, the easiest thing to do is set cts_WaitSelection-&gt;timeout_msec to 35000 ms (maybe even longer if you set options[8..9] because this may prolongate the technology selection). Then you have to call <a class="el" href="tec_8h.html#aee5b104d8ad6e85feddb685379cdbf0c">cts_WaitSelection()</a> only once, it blocks and returns as soon as a result is available. This works of course only if cts_StartSelection-&gt;timeout_sec does not exceed ~60 seconds. If you set cts_WaitSelection-&gt;timeout_msec to smaller values you have to call the function in a loop until a result (something != CTS_IN_PROGRESS) is returned. This makes sense if you want to do other things in the same thread while waiting for result of technology selection, e.g. you may want to call <a class="el" href="tec_8h.html#acaf2d75d1b584ae97ff9ee4da47cee38">cts_StopSelection()</a> if abort request arrived from GUI or ECR. So in this case the timeout depends on the frequency with that you want to do the other things, e.g. a timeout of 0 is possible but will lead to high system load wheras a timeout of 100ms seems reasonable.</p>
<p>Q: Some time ago, upon reviewing our test logs, you pointed out that we should not call the API <a class="el" href="msr_8h.html#a1e92fd29720fecbf50da24a30c7b512f">MSR_Activate()</a> if next we start the selection with the API <a class="el" href="tec_8h.html#ac6699fe32fc23e90713eb617e9ff25e7">cts_StartSelection()</a> because the latter activates the reader by itself. And what about the scenario when we want to establish the MSR callback and then use the selection? Here, <a class="el" href="msr_8h.html#a1e92fd29720fecbf50da24a30c7b512f">MSR_Activate()</a> is the only way to establish such a callback. Is this a legal use case to use simultaneously the MSR callback and the selection which, in turn, may have its own callback?</p>
<p>A: No, this is not a legal use case. You should not establish the MSR callback if you use technology selection. This is confusing and not necessary anyway. If MSR data is available, technology selection will finish, so you get the information from TEC, no need to set MSR callback. If you even call <a class="el" href="msr_8h.html#ad00fdde838f486d43be689650ab58d43">MSR_GetData()</a> upon receiving MSR callback, TEC would most likely not be able to detect that MSR data is available and continue waiting for technology (TEC calls <a class="el" href="msr_8h.html#a8096fa193f035eb4b80673260d720477">MSR_DataAvailable()</a> and as soon as <a class="el" href="msr_8h.html#ad00fdde838f486d43be689650ab58d43">MSR_GetData()</a> is called, the former will return 'no data available'). So please do not do anything like this.</p>
<h2><a class="anchor" id="subsec_tec_logging"></a>
Logging</h2>
<p>You have two options to enable logging, choose one of them (if you think this is helpful, you could actually use both at once):</p><ul>
<li>Register a trace callback function with <a class="el" href="tec__common_8h.html#a90770d44c55c14fa472396c74fec6052">cts_SetTraceCallback()</a>.</li>
<li>Use ADK-LOG: Configure logging channel "TEC" by means of log control panel.</li>
</ul>
<p><br  />
</p>
<h1><a class="anchor" id="sec_tec_appendix"></a>
Appendix</h1>
<p>Appendix is empty. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div class="ttc" id="atec_8h_html"><div class="ttname"><a href="tec_8h.html">tec.h</a></div></div>
<div class="ttc" id="agroup___t_e_c___r_e_t_u_r_n___c_o_d_e_s_html_ga7cc5cc3d019136c0a8942e62c558b69c"><div class="ttname"><a href="group___t_e_c___r_e_t_u_r_n___c_o_d_e_s.html#ga7cc5cc3d019136c0a8942e62c558b69c">CTS_STOPPED</a></div><div class="ttdeci">#define CTS_STOPPED</div><div class="ttdef"><b>Definition:</b> tec_common.h:35</div></div>
<div class="ttc" id="a_v_h_q__vfisyspm__wrapper_8cpp_html_a70aa738d3c50b0bbed156ee52c84679d"><div class="ttname"><a href="_v_h_q__vfisyspm__wrapper_8cpp.html#a70aa738d3c50b0bbed156ee52c84679d">if</a></div><div class="ttdeci">if(vfisyspm_inited==0)</div><div class="ttdef"><b>Definition:</b> VHQ_vfisyspm_wrapper.cpp:215</div></div>
<div class="ttc" id="agroup___f_u_n_c___f_l_o_w_html_ga1a86c76dcf8fec6e97ead6cf8f2717ff"><div class="ttname"><a href="group___f_u_n_c___f_l_o_w.html#ga1a86c76dcf8fec6e97ead6cf8f2717ff">EMV_CTLS_SetupTransaction</a></div><div class="ttdeci">DLL_CLC EMV_ADK_INFO EMV_CTLS_SetupTransaction(EMV_CTLS_START_TYPE *pxStartInput, EMV_CTLS_STARTRES_TYPE *pxStartRes)</div><div class="ttdoc">Set up a CTLS EMV transaction.</div></div>
<div class="ttc" id="asdi__nfc_8h_html_a7a9419cd6aa7aa9185fb249ce761ae0f"><div class="ttname"><a href="sdi__nfc_8h.html#a7a9419cd6aa7aa9185fb249ce761ae0f">NFC_Client_Init</a></div><div class="ttdeci">#define NFC_Client_Init</div><div class="ttdef"><b>Definition:</b> sdi_nfc.h:383</div></div>
<div class="ttc" id="atec_8h_html_aee5b104d8ad6e85feddb685379cdbf0c"><div class="ttname"><a href="tec_8h.html#aee5b104d8ad6e85feddb685379cdbf0c">cts_WaitSelection</a></div><div class="ttdeci">int cts_WaitSelection(unsigned char *usedTechnology, unsigned char *dataBuffer, unsigned short *dataBufferLength, unsigned short timeout_msec)</div></div>
<div class="ttc" id="agroup___t_e_c___r_e_t_u_r_n___c_o_d_e_s_html_gae1d5a1303c3edd9aa78e9ed9b8c3207a"><div class="ttname"><a href="group___t_e_c___r_e_t_u_r_n___c_o_d_e_s.html#gae1d5a1303c3edd9aa78e9ed9b8c3207a">CTS_TIMEOUT</a></div><div class="ttdeci">#define CTS_TIMEOUT</div><div class="ttdef"><b>Definition:</b> tec_common.h:32</div></div>
<div class="ttc" id="atec_8h_html_acaf2d75d1b584ae97ff9ee4da47cee38"><div class="ttname"><a href="tec_8h.html#acaf2d75d1b584ae97ff9ee4da47cee38">cts_StopSelection</a></div><div class="ttdeci">int cts_StopSelection(void)</div></div>
<div class="ttc" id="agroup___m_s_r___o_p_t_i_o_n_s___b_i_t_m_a_s_k_html_ga2a413b4af9749ddf671d95422930aa38"><div class="ttname"><a href="group___m_s_r___o_p_t_i_o_n_s___b_i_t_m_a_s_k.html#ga2a413b4af9749ddf671d95422930aa38">MSR_UX_ENHANCEMENTS</a></div><div class="ttdeci">#define MSR_UX_ENHANCEMENTS</div><div class="ttdoc">options[0] Hybrid reader: ignore card insertion</div><div class="ttdef"><b>Definition:</b> msr_common.h:63</div></div>
<div class="ttc" id="amsr_8h_html_aac28b2c3771f8221fc26a35f0fd6d0f8"><div class="ttname"><a href="msr_8h.html#aac28b2c3771f8221fc26a35f0fd6d0f8">MSR_Deactivate</a></div><div class="ttdeci">int MSR_Deactivate(void)</div></div>
<div class="ttc" id="amsr_8h_html_ac3c6f568aa57690a8b369936fc362c2a"><div class="ttname"><a href="msr_8h.html#ac3c6f568aa57690a8b369936fc362c2a">MSR_SetOptions</a></div><div class="ttdeci">int MSR_SetOptions(unsigned char *options, unsigned char options_len)</div></div>
<div class="ttc" id="agroup___t_e_c___r_e_t_u_r_n___c_o_d_e_s_html_ga7ee2b62641a168354503adbb06508deb"><div class="ttname"><a href="group___t_e_c___r_e_t_u_r_n___c_o_d_e_s.html#ga7ee2b62641a168354503adbb06508deb">CTS_IN_PROGRESS</a></div><div class="ttdeci">#define CTS_IN_PROGRESS</div><div class="ttdef"><b>Definition:</b> tec_common.h:31</div></div>
<div class="ttc" id="agroup___f_u_n_c___f_l_o_w_html_ga297b6843994afaa2e7a6f5e0e4a8af3e"><div class="ttname"><a href="group___f_u_n_c___f_l_o_w.html#ga297b6843994afaa2e7a6f5e0e4a8af3e">EMV_CTLS_ContinueOnline</a></div><div class="ttdeci">DLL_CLC EMV_ADK_INFO EMV_CTLS_ContinueOnline(EMV_CTLS_HOST_TYPE *pxOnlineInput, EMV_CTLS_TRANSRES_TYPE *pxTransRes)</div><div class="ttdoc">EMV transaction (handling of host response including 2nd cryptogram)</div></div>
<div class="ttc" id="atec_8h_html_a92ab7780df1f8150c6d8a9b3ab3163bf"><div class="ttname"><a href="tec_8h.html#a92ab7780df1f8150c6d8a9b3ab3163bf">cts_WaitCardRemoval2</a></div><div class="ttdeci">int cts_WaitCardRemoval2(unsigned short timeout_sec)</div></div>
<div class="ttc" id="agroup___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s_html_gaece6355aecbe1744ed15e5b41e0e6c15"><div class="ttname"><a href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gaece6355aecbe1744ed15e5b41e0e6c15">CTS_MSR</a></div><div class="ttdeci">#define CTS_MSR</div><div class="ttdef"><b>Definition:</b> tec_common.h:18</div></div>
<div class="ttc" id="atitusstubs_8cpp_html_a8ee28a30cc5757bdd4d9ac413fe7ef17"><div class="ttname"><a href="titusstubs_8cpp.html#a8ee28a30cc5757bdd4d9ac413fe7ef17">NFC_VAS_PreLoad</a></div><div class="ttdeci">VasStatus NFC_VAS_PreLoad(rawData *id, rawData *input, rawData *output)</div><div class="ttdef"><b>Definition:</b> titusstubs.cpp:660</div></div>
<div class="ttc" id="agroup___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s_html_gadbc63cc59da76fff7974cd5631f56662"><div class="ttname"><a href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#gadbc63cc59da76fff7974cd5631f56662">CTS_CHIP</a></div><div class="ttdeci">#define CTS_CHIP</div><div class="ttdef"><b>Definition:</b> tec_common.h:17</div></div>
<div class="ttc" id="a_e_m_v___c_t___interface_8h_html"><div class="ttname"><a href="_e_m_v___c_t___interface_8h.html">EMV_CT_Interface.h</a></div><div class="ttdoc">Interface of CT-Client.</div></div>
<div class="ttc" id="agroup___t_e_c___r_e_t_u_r_n___c_o_d_e_s_html_ga1952f713ce2bbfa1d8b54142ca52ecc4"><div class="ttname"><a href="group___t_e_c___r_e_t_u_r_n___c_o_d_e_s.html#ga1952f713ce2bbfa1d8b54142ca52ecc4">CTS_OK</a></div><div class="ttdeci">#define CTS_OK</div><div class="ttdef"><b>Definition:</b> tec_common.h:29</div></div>
<div class="ttc" id="atec__common_8h_html_a56386219739d173835a83194608fedea"><div class="ttname"><a href="tec__common_8h.html#a56386219739d173835a83194608fedea">CTS_DATA_TLV</a></div><div class="ttdeci">#define CTS_DATA_TLV</div><div class="ttdef"><b>Definition:</b> tec_common.h:23</div></div>
<div class="ttc" id="amsr_8h_html_ad00fdde838f486d43be689650ab58d43"><div class="ttname"><a href="msr_8h.html#ad00fdde838f486d43be689650ab58d43">MSR_GetData</a></div><div class="ttdeci">int MSR_GetData(int timeout_msec, MSR_TrackData *tracks, MSR_DecodedData *data)</div></div>
<div class="ttc" id="atitusstubs_8cpp_html_ad0a349a0904d698fea9fffa004cb3eb3"><div class="ttname"><a href="titusstubs_8cpp.html#ad0a349a0904d698fea9fffa004cb3eb3">NFC_Terminal_Config</a></div><div class="ttdeci">VasStatus NFC_Terminal_Config(rawData *input, rawData *output)</div><div class="ttdef"><b>Definition:</b> titusstubs.cpp:632</div></div>
<div class="ttc" id="a_e_m_v___c_t_l_s___interface_8h_html"><div class="ttname"><a href="_e_m_v___c_t_l_s___interface_8h.html">EMV_CTLS_Interface.h</a></div><div class="ttdoc">Interface of CTLS-Client.</div></div>
<div class="ttc" id="agroup___f_u_n_c___f_l_o_w_html_gaf23f6f87fe90619810470fad7d11f321"><div class="ttname"><a href="group___f_u_n_c___f_l_o_w.html#gaf23f6f87fe90619810470fad7d11f321">EMV_CTLS_ContinueOffline</a></div><div class="ttdeci">DLL_CLC EMV_ADK_INFO EMV_CTLS_ContinueOffline(EMV_CTLS_TRANSRES_TYPE *pxTransRes)</div><div class="ttdoc">CTLS EMV transaction (offline part ... including 1st cryptogram, depends on CTLS scheme)</div></div>
<div class="ttc" id="atitusstubs_8cpp_html_a8816583d91da702a6c7e2143ed68f7d9"><div class="ttname"><a href="titusstubs_8cpp.html#a8816583d91da702a6c7e2143ed68f7d9">NFC_VAS_UpdateConfig</a></div><div class="ttdeci">VasStatus NFC_VAS_UpdateConfig(rawData *id, rawData *input, rawData *output)</div><div class="ttdef"><b>Definition:</b> titusstubs.cpp:652</div></div>
<div class="ttc" id="agroup___t_e_c___s_t_a_r_t___o_p_t_i_o_n_s_html_ga4678a7752f0337b236971dcd370edf93"><div class="ttname"><a href="group___t_e_c___s_t_a_r_t___o_p_t_i_o_n_s.html#ga4678a7752f0337b236971dcd370edf93">CTS_VAS_ENABLE</a></div><div class="ttdeci">#define CTS_VAS_ENABLE</div><div class="ttdef"><b>Definition:</b> tec_common.h:67</div></div>
<div class="ttc" id="agroup___t_e_c___s_t_a_r_t___o_p_t_i_o_n_s_html_gaafe9099680a56edd52a1258a797efa07"><div class="ttname"><a href="group___t_e_c___s_t_a_r_t___o_p_t_i_o_n_s.html#gaafe9099680a56edd52a1258a797efa07">CTS_NFC_ENABLE</a></div><div class="ttdeci">#define CTS_NFC_ENABLE</div><div class="ttdef"><b>Definition:</b> tec_common.h:65</div></div>
<div class="ttc" id="agroup___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s_html_ga56e64c2a97c61e8cb043de2852986a3a"><div class="ttname"><a href="group___t_e_c___t_e_c_h_n_o_l_o_g_i_e_s.html#ga56e64c2a97c61e8cb043de2852986a3a">CTS_CTLS</a></div><div class="ttdeci">#define CTS_CTLS</div><div class="ttdef"><b>Definition:</b> tec_common.h:19</div></div>
<div class="ttc" id="atec_8h_html_aa237be1f0249503d0b959d3800f1ee34"><div class="ttname"><a href="tec_8h.html#aa237be1f0249503d0b959d3800f1ee34">cts_SetOptions</a></div><div class="ttdeci">int cts_SetOptions(const unsigned char *options, unsigned char options_len)</div></div>
<div class="ttc" id="agroup___t_e_c___s_t_a_r_t___o_p_t_i_o_n_s_html_ga16d617787fe23f80aae81a4c3bc944bf"><div class="ttname"><a href="group___t_e_c___s_t_a_r_t___o_p_t_i_o_n_s.html#ga16d617787fe23f80aae81a4c3bc944bf">CTS_EMV_AFTER_NFC_ISO</a></div><div class="ttdeci">#define CTS_EMV_AFTER_NFC_ISO</div><div class="ttdef"><b>Definition:</b> tec_common.h:69</div></div>
<div class="ttc" id="agroup___f_u_n_c___f_l_o_w_html_ga42f570d2b8e66841ab9e8de7736e92d4"><div class="ttname"><a href="group___f_u_n_c___f_l_o_w.html#ga42f570d2b8e66841ab9e8de7736e92d4">EMV_CT_ContinueOnline</a></div><div class="ttdeci">DLL_CTC EMV_ADK_INFO EMV_CT_ContinueOnline(EMV_CT_HOST_TYPE *pxOnlineInput, EMV_CT_TRANSRES_TYPE *pxTransRes)</div><div class="ttdoc">EMV transaction (handling of host response including 2nd cryptogram)</div></div>
<div class="ttc" id="agroup___f_u_n_c___f_l_o_w_html_ga2b4820be53959b56fb7f672bd54f4e63"><div class="ttname"><a href="group___f_u_n_c___f_l_o_w.html#ga2b4820be53959b56fb7f672bd54f4e63">EMV_CTLS_Break</a></div><div class="ttdeci">DLL_CLC unsigned char EMV_CTLS_Break(void)</div><div class="ttdoc">Universal break command    Velocity: Only required when using EMV_CTLS_START_STRUCT::ServerPollTimeou...</div></div>
<div class="ttc" id="agroup___f_u_n_c___f_l_o_w_html_ga8be6df6babc587a19f63f284b2a6f006"><div class="ttname"><a href="group___f_u_n_c___f_l_o_w.html#ga8be6df6babc587a19f63f284b2a6f006">EMV_CT_ContinueOffline</a></div><div class="ttdeci">DLL_CTC EMV_ADK_INFO EMV_CT_ContinueOffline(EMV_CT_TRANSAC_TYPE *pxTransactionInput, EMV_CT_TRANSRES_TYPE *pxTransRes)</div><div class="ttdoc">EMV transaction (offline part including 1st cryptogram)</div></div>
<div class="ttc" id="atec_8h_html_ac6699fe32fc23e90713eb617e9ff25e7"><div class="ttname"><a href="tec_8h.html#ac6699fe32fc23e90713eb617e9ff25e7">cts_StartSelection</a></div><div class="ttdeci">int cts_StartSelection(unsigned char supportedTechnologies, unsigned short timeout_sec, cts_Callback cbf, void *cb_data, unsigned char *options, unsigned char options_len)</div></div>
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Application Development Kit (ADK)</a></li><li class="navelem"><a class="el" href="system_overview.html">System Overview</a></li><li class="navelem"><a class="el" href="pg_all_components.html">ADK Components</a></li>
    <li class="footer">Generated on Mon Jun 16 2025 16:04:02 for ADK-Programmers-Guides by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>

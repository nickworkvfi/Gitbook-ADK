<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ADK-Programmers-Guides: sdi/src/main.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="verifone.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="verifonelogo.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ADK-Programmers-Guides
   &#160;<span id="projectnumber">5.0.3-CD1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('main_8h.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">main.h File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;vector&gt;</code><br />
<code>#include &lt;string&gt;</code><br />
<code>#include &lt;pthread.h&gt;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for main.h:</div>
<div class="dyncontent">
<div class="center"><img src="main_8h__incl.png" border="0" usemap="#sdi_2src_2main_8h" alt=""/></div>
<map name="sdi_2src_2main_8h" id="sdi_2src_2main_8h">
<area shape="rect" title=" " alt="" coords="65,5,179,32"/>
<area shape="rect" title=" " alt="" coords="5,80,68,107"/>
<area shape="rect" title=" " alt="" coords="93,80,151,107"/>
<area shape="rect" title=" " alt="" coords="176,80,260,107"/>
</map>
</div>
</div><div class="textblock"><div class="dynheader">
This graph shows which files directly or indirectly include this file:</div>
<div class="dyncontent">
<div class="center"><img src="main_8h__dep__incl.png" border="0" usemap="#sdi_2src_2main_8hdep" alt=""/></div>
<map name="sdi_2src_2main_8hdep" id="sdi_2src_2main_8hdep">
<area shape="rect" title=" " alt="" coords="325,5,439,32"/>
<area shape="rect" href="madk__pp__protocol_8cpp.html" title=" " alt="" coords="5,80,220,107"/>
<area shape="rect" href="main_8cpp.html" title=" " alt="" coords="245,80,373,107"/>
<area shape="rect" href="sys_8cpp.html" title=" " alt="" coords="397,80,514,107"/>
<area shape="rect" href="ui__mode_8cpp.html" title=" " alt="" coords="539,80,689,107"/>
</map>
</div>
</div>
<p><a href="main_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:afdcd133c96d68afb81d874f88786367e"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8h.html#afdcd133c96d68afb81d874f88786367e">dispatch</a> (std::vector&lt; unsigned char &gt; &amp;cmd)</td></tr>
<tr class="separator:afdcd133c96d68afb81d874f88786367e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4892e1b795462119ef4d6fa87c860b90"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8h.html#a4892e1b795462119ef4d6fa87c860b90">process_side_command</a> (unsigned char *cmd, unsigned size)</td></tr>
<tr class="separator:a4892e1b795462119ef4d6fa87c860b90"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab39e67ca68823580152fc861898a77da"><td class="memItemLeft" align="right" valign="top">unsigned short&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8h.html#ab39e67ca68823580152fc861898a77da">check_mac_decrypt</a> (unsigned char *cmd, unsigned &amp;cmdSize, std::vector&lt; unsigned char &gt; &amp;out)</td></tr>
<tr class="separator:ab39e67ca68823580152fc861898a77da"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a11c5a1b173cf19d42db73a73a1ad6d90"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8h.html#a11c5a1b173cf19d42db73a73a1ad6d90">pm_setCriticalSection</a> (bool enable)</td></tr>
<tr class="separator:a11c5a1b173cf19d42db73a73a1ad6d90"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2640a9e85a15b5c3a3e800e532939c67"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8h.html#a2640a9e85a15b5c3a3e800e532939c67">pm_criticalSection</a> ()</td></tr>
<tr class="separator:a2640a9e85a15b5c3a3e800e532939c67"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aeeb65deaf7e0b30961e4cb56c8105b41"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8h.html#aeeb65deaf7e0b30961e4cb56c8105b41">sdi_exit</a> (int status)</td></tr>
<tr class="separator:aeeb65deaf7e0b30961e4cb56c8105b41"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a id="ab39e67ca68823580152fc861898a77da"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab39e67ca68823580152fc861898a77da">&#9670;&nbsp;</a></span>check_mac_decrypt()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">unsigned short check_mac_decrypt </td>
          <td>(</td>
          <td class="paramtype">unsigned char *&#160;</td>
          <td class="paramname"><em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned &amp;&#160;</td>
          <td class="paramname"><em>cmdSize</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; unsigned char &gt; &amp;&#160;</td>
          <td class="paramname"><em>out</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>The function is invoked by SDI connection thread (such as invoking <a class="el" href="classm_a_d_k___p_p___prot.html#ab390ac45aaaa013d33bcef40d625f142">mADK_PP_Prot::set_command()</a>) to check for an incomming SDI command, if security options in P1 field were enabled. In case with bit 0x40 set: The function calculates the MAC from incomming command and checks if it equals with MAC appended to command. After successful MAC check, the MAC is removed from command tail and not returned in output vector <em>out</em>. IN case with bit 0x80 set: The function decrypts the command and provides the plain text command data in output vector <em>out</em>. Both option bits can be combined. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">cmd</td><td>pointer to origin incomming command buffer, which might be encrypted or appended with a MAC. Pointer <em>cmd</em> is allowed to point to &amp;out[0], but please note that <a class="el" href="namespacevficom_1_1cmdparam_1_1in_1_1ping.html#ae0d180616fe53dddd61f70c62526b0db" title="integer - [optional] use &quot;size&quot; as number of data bytes to be sent, default 56">out.size()</a> must be at least <em>cmdSize</em> in this case. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">cmdSize</td><td>in: size of the incomming command, cmdSize (size of buffer <em>cmd</em>) must be at least 4 bytes! out: size of valid data returned in output vector <em>out</em>. Note: The real command size is always provided with <em>cmdSize</em> (<a class="el" href="namespacevficom_1_1cmdparam_1_1in_1_1ping.html#ae0d180616fe53dddd61f70c62526b0db" title="integer - [optional] use &quot;size&quot; as number of data bytes to be sent, default 56">out.size()</a> might be creater!) </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">out</td><td>decrypted data, always without MAC For incomming vector with <a class="el" href="namespacevficom_1_1cmdparam_1_1in_1_1ping.html#ae0d180616fe53dddd61f70c62526b0db" title="integer - [optional] use &quot;size&quot; as number of data bytes to be sent, default 56">out.size()</a> &gt; 0, this size is least kept. This is to keep pre-allocated command vector for <a class="el" href="main_8h.html#afdcd133c96d68afb81d874f88786367e">dispatch()</a>, which uses this function. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>error code 0x9000 if all operations were successful or no security options enabled, else another error code is returned, e.g. 0x6FB9 (decryption error) </dd></dl>
<dl class="section note"><dt>Note</dt><dd>Invocation of <a class="el" href="main_8h.html#ab39e67ca68823580152fc861898a77da">check_mac_decrypt()</a> was moved to <a class="el" href="classm_a_d_k___p_p___prot.html#ab390ac45aaaa013d33bcef40d625f142">mADK_PP_Prot::set_command()</a>, otherwise <a class="el" href="main_8h.html#afdcd133c96d68afb81d874f88786367e">dispatch()</a> would to it a second time after <a class="el" href="main_8h.html#a4892e1b795462119ef4d6fa87c860b90">process_side_command()</a>, when using protocol type D. See also add_mac_encrypt(), which is invoked by <a class="el" href="main_8h.html#afdcd133c96d68afb81d874f88786367e">dispatch()</a> and <a class="el" href="main_8h.html#a4892e1b795462119ef4d6fa87c860b90">process_side_command()</a> to handle secure responses. </dd></dl>

</div>
</div>
<a id="afdcd133c96d68afb81d874f88786367e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afdcd133c96d68afb81d874f88786367e">&#9670;&nbsp;</a></span>dispatch()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void dispatch </td>
          <td>(</td>
          <td class="paramtype">std::vector&lt; unsigned char &gt; &amp;&#160;</td>
          <td class="paramname"><em>cmd</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Function to process a command with the SDI main thread synchronously. The function provides the full SDI function scope (e.g. including payment support with ADKEMV, ADKNFC and ADKMSR). Most subfunctions invoked by <a class="el" href="main_8h.html#afdcd133c96d68afb81d874f88786367e">dispatch()</a> are CPU bound or might block, e.g. to wait for user input with UI, thus, the are processed by the a working thread, the SDI main thread. Function <a class="el" href="main_8h.html#afdcd133c96d68afb81d874f88786367e">dispatch()</a> cannot be invoked by multiple threads simultanously. A second thread invoking it at the same time is blocked by a mutex, which will lead to delayed processing consequently (as long as the previous thread hasn't finshed processing) or finally to a processing timeout. Since the used mutex allowes recursive locking with the same thread, it is possible to use <a class="el" href="main_8h.html#afdcd133c96d68afb81d874f88786367e">dispatch()</a> for processing a nested command from within an active SDI callback, if this was invoked by the SDI main thread. Other sibling threads (created by the SDI main thread) will only be able the invoke <a class="el" href="main_8h.html#afdcd133c96d68afb81d874f88786367e">dispatch()</a>, if the SDI main thread has unlocked the mutex previously (e.g. as implemented for command Card Detection 23-01). </p><dl class="section note"><dt>Note</dt><dd>SDI connection threads (such as invoking <a class="el" href="classm_a_d_k___p_p___prot.html#ab390ac45aaaa013d33bcef40d625f142">mADK_PP_Prot::set_command()</a>) must never invoke function <a class="el" href="main_8h.html#afdcd133c96d68afb81d874f88786367e">dispatch()</a>, since these threads are fully decoupled from SDI main thread and must use <a class="el" href="main_8h.html#a4892e1b795462119ef4d6fa87c860b90">process_side_command()</a> instead. Even SDI allows using <a class="el" href="main_8h.html#afdcd133c96d68afb81d874f88786367e">dispatch()</a> for asynchronous commands with protocol type 'D' over the main connection, the related connection thread stores the command into command buffer, so that the main thread (calling <a class="el" href="classm_a_d_k___p_p___prot.html#ab2e55bafa77bcbdbeda4258ecadd5357">mADK_PP_Prot::receive()</a> in idle loop) can take ownership to process the command synchronously. Thus, a second simultaneous protocol type 'D' command on the main connection is declined with a busy response 640A, while the previous command is already processed by the main thread. </dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">cmd</td><td>vector as buffer storing the command to be processed </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a2640a9e85a15b5c3a3e800e532939c67"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2640a9e85a15b5c3a3e800e532939c67">&#9670;&nbsp;</a></span>pm_criticalSection()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool pm_criticalSection </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>check if SDI has entered critical PM section with <a class="el" href="main_8h.html#a11c5a1b173cf19d42db73a73a1ad6d90">pm_setCriticalSection()</a>. </p><dl class="section return"><dt>Returns</dt><dd>true if SDI has entered critical PM section, else false. </dd></dl>

</div>
</div>
<a id="a11c5a1b173cf19d42db73a73a1ad6d90"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a11c5a1b173cf19d42db73a73a1ad6d90">&#9670;&nbsp;</a></span>pm_setCriticalSection()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void pm_setCriticalSection </td>
          <td>(</td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>enable</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Enter/leave critical section of power management (PM). If true is passed for parameter <em>enable</em>, it invokes <a class="el" href="namespacevfisyspm.html#ac46060410ba78b557470d51eb9c90feb">sys_CriticalSectionEnter()</a>, in case of false <a class="el" href="namespacevfisyspm.html#a1fe354c573d66613fbae37897509cf04">sys_CriticalSectionExit()</a> is called. For more details please refer to documentation of ADKPM. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">enable</td><td>true to enter critical PM section false to leave critical PM section </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a4892e1b795462119ef4d6fa87c860b90"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4892e1b795462119ef4d6fa87c860b90">&#9670;&nbsp;</a></span>process_side_command()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool process_side_command </td>
          <td>(</td>
          <td class="paramtype">unsigned char *&#160;</td>
          <td class="paramname"><em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned&#160;</td>
          <td class="paramname"><em>size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Function to process a command as a side command, which was triggered by a side connection with protocol type 'C' asynchronously or by an asynchronous command with protocol type 'D'. The function is invoked by SDI connection thread (such as invoking <a class="el" href="classm_a_d_k___p_p___prot.html#ab390ac45aaaa013d33bcef40d625f142">mADK_PP_Prot::set_command()</a>), thus, these threads are fully decoupled from SDI main thread processing (see function <a class="el" href="main_8h.html#afdcd133c96d68afb81d874f88786367e">dispatch()</a>). Subfunctions invoked by <a class="el" href="main_8h.html#a4892e1b795462119ef4d6fa87c860b90">process_side_command()</a> are invoked simultaneously, thus, they must be implemented thread-safe!!! If the command is not supported to be executed as a side command, the function returns false, which means that the command requires execution of <a class="el" href="main_8h.html#afdcd133c96d68afb81d874f88786367e">dispatch()</a> with the SDI main thread. Side commands just have restricted access to SDI function scope and do not support intermediate messages like requests (callbacks) or aborts, they just use internal function <a class="el" href="classm_a_d_k___p_p___prot.html#a1f13b08d59a38adeb5d755179befa6b8">mADK_PP_Prot::send()</a> to reply the command. Therefore, side commands are usually short-term in nature. </p><dl class="section note"><dt>Note</dt><dd>This function is not allowed to use protocol function like <a class="el" href="classm_a_d_k___p_p___prot.html#ab2e55bafa77bcbdbeda4258ecadd5357">mADK_PP_Prot::receive()</a>, <a class="el" href="classm_a_d_k___p_p___prot.html#a345e47376ab38e76aa77b2bd774b104d">mADK_PP_Prot::command()</a>, <a class="el" href="classm_a_d_k___p_p___prot.html#a1630f914c3dbf9ebc62ad6a5c7f9ebd9">mADK_PP_Prot::request()</a> or <a class="el" href="classm_a_d_k___p_p___prot.html#a0bb666307a7aa15fc7aae63d454e4394">mADK_PP_Prot::recv_response()</a>. These APIs are only allowed for SDI application threads (main thread and siblings), which process commands received on the main connection (see function <a class="el" href="main_8h.html#afdcd133c96d68afb81d874f88786367e">dispatch()</a>). </dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">cmd</td><td>pointer to command buffer </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">size</td><td>size of command buffer </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>true if command was executed and rsp contains a response, false in case invocation is not allowed by a side command and requires execution of <a class="el" href="main_8h.html#afdcd133c96d68afb81d874f88786367e">dispatch()</a> with the SDI main thread. </dd></dl>

</div>
</div>
<a id="aeeb65deaf7e0b30961e4cb56c8105b41"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aeeb65deaf7e0b30961e4cb56c8105b41">&#9670;&nbsp;</a></span>sdi_exit()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void sdi_exit </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>status</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>depending on platform SDI must call exit() or _exit(). This function ensures to use the correct variant, therefore, it shall be used instead of using functions of stdlib directly. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">status</td><td>exit code of SDI </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_44d926a17fc606d3c25449ba60427c63.html">sdi</a></li><li class="navelem"><a class="el" href="dir_048f823fee1bfb22502a8732b9a001aa.html">src</a></li><li class="navelem"><a class="el" href="main_8h.html">main.h</a></li>
    <li class="footer">Generated on Mon Jun 16 2025 16:03:57 for ADK-Programmers-Guides by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>

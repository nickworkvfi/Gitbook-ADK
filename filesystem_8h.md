---
title: sdi/src/filesystem.h

---

# sdi/src/filesystem.h



## Namespaces

| Name           |
| -------------- |
| **[sdi](namespacesdi.md)**  |
| **[sdi::filesystem](namespacesdi_1_1filesystem.md)**  |

## Defines

|                | Name           |
| -------------- | -------------- |
|  | **[COM_PREFIX](filesystem_8h.md#define-com-prefix)**  |
|  | **[COM_ANDROID](filesystem_8h.md#define-com-android)**  |
|  | **[CONNECT_LAN_FILE](filesystem_8h.md#define-connect-lan-file)**  |
|  | **[CONNECT_BT_FILE](filesystem_8h.md#define-connect-bt-file)**  |
|  | **[CONNECT_WIFI_FILE](filesystem_8h.md#define-connect-wifi-file)**  |
|  | **[CONNECT_USB_SER_FILE](filesystem_8h.md#define-connect-usb-ser-file)**  |
|  | **[CONNECT_USB_LAN_FILE](filesystem_8h.md#define-connect-usb-lan-file)**  |
|  | **[CONNECT_COM1A_FILE](filesystem_8h.md#define-connect-com1a-file)**  |
|  | **[CONNECT_BLE_FILE](filesystem_8h.md#define-connect-ble-file)**  |
|  | **[CONNECT_COM1_FILE](filesystem_8h.md#define-connect-com1-file)**  |
|  | **[CONNECT_ANY_FILE](filesystem_8h.md#define-connect-any-file)**  |
|  | **[CONNECT_LO_FILE](filesystem_8h.md#define-connect-lo-file)**  |
|  | **[CONNECT_ANDROID_FILE](filesystem_8h.md#define-connect-android-file)**  |
|  | **[BLE_GATT_FILE](filesystem_8h.md#define-ble-gatt-file)**  |
|  | **[LOCAL_NET_BT_PAN_FILE](filesystem_8h.md#define-local-net-bt-pan-file)**  |
|  | **[CCP_DATABASE_FILE](filesystem_8h.md#define-ccp-database-file)**  |
|  | **[COM_IF_CONFIG_FILE](filesystem_8h.md#define-com-if-config-file)**  |
|  | **[SEC_PREFIX](filesystem_8h.md#define-sec-prefix)**  |
|  | **[ADKSEC_CONFIG_FILE](filesystem_8h.md#define-adksec-config-file)**  |
|  | **[EPP_PREFIX](filesystem_8h.md#define-epp-prefix)**  |
|  | **[CT_PREFIX](filesystem_8h.md#define-ct-prefix)**  |
|  | **[EPP_CONFIG_FILE](filesystem_8h.md#define-epp-config-file)**  |
|  | **[LOCAL_NET_USB_CT](filesystem_8h.md#define-local-net-usb-ct)**  |
|  | **[LOCAL_NET_USB_EPP](filesystem_8h.md#define-local-net-usb-epp)**  |
|  | **[CONNECT_EPP_TLS](filesystem_8h.md#define-connect-epp-tls)**  |
|  | **[EMV_PREFIX](filesystem_8h.md#define-emv-prefix)**  |
|  | **[EMV_DESIRED_FILE](filesystem_8h.md#define-emv-desired-file)**  |
|  | **[EMV_FLASH_CONFIG_FILES](filesystem_8h.md#define-emv-flash-config-files)**  |
|  | **[SDI_TRX_DATA_FILE](filesystem_8h.md#define-sdi-trx-data-file)**  |
|  | **[WHITELIST_FILE](filesystem_8h.md#define-whitelist-file)**  |
|  | **[SENSITIVE_TAGS_FILE](filesystem_8h.md#define-sensitive-tags-file)**  |
|  | **[CARD_RANGES_FILE](filesystem_8h.md#define-card-ranges-file)**  |
|  | **[STATUS_CFG_FILE](filesystem_8h.md#define-status-cfg-file)**  |
|  | **[IDLETEXT_CFG_FILE](filesystem_8h.md#define-idletext-cfg-file)**  |
|  | **[SDI_CONFIG_FILE](filesystem_8h.md#define-sdi-config-file)**  |
|  | **[SDI_ACL_FILE](filesystem_8h.md#define-sdi-acl-file)**  |
|  | **[FS_CHECKSUMS_FILE](filesystem_8h.md#define-fs-checksums-file)**  |
|  | **[UPDATE_REMOVE_FILE](filesystem_8h.md#define-update-remove-file)**  |
|  | **[PLUGIN_PREFIX](filesystem_8h.md#define-plugin-prefix)**  |
|  | **[PLUGIN_EXT](filesystem_8h.md#define-plugin-ext)**  |
|  | **[PLUGIN_PATTERN](filesystem_8h.md#define-plugin-pattern)**  |
|  | **[PLUGIN_CONFIG_PATTERN](filesystem_8h.md#define-plugin-config-pattern)**  |
|  | **[GCKERNEL_PATTERN](filesystem_8h.md#define-gckernel-pattern)**  |
|  | **[LOG_PREFIX](filesystem_8h.md#define-log-prefix)**  |
|  | **[LOG_CONFIG_FILES](filesystem_8h.md#define-log-config-files)**  |
|  | **[NFC_PREFIX](filesystem_8h.md#define-nfc-prefix)**  |
|  | **[NFC_WKY_FILES](filesystem_8h.md#define-nfc-wky-files)**  |
|  | **[FONT_PREFIX](filesystem_8h.md#define-font-prefix)**  |
|  | **[FONT_FILES](filesystem_8h.md#define-font-files)**  |
|  | **[EMV_CONFIG_TARBALL](filesystem_8h.md#define-emv-config-tarball)**  |




## Macros Documentation

### define COM_PREFIX

```cpp
#define COM_PREFIX "com/"
```


### define COM_ANDROID

```cpp
#define COM_ANDROID "com/android/"
```


### define CONNECT_LAN_FILE

```cpp
#define CONNECT_LAN_FILE "CONNECT_LAN.XML"
```


### define CONNECT_BT_FILE

```cpp
#define CONNECT_BT_FILE "CONNECT_BT.XML"
```


### define CONNECT_WIFI_FILE

```cpp
#define CONNECT_WIFI_FILE "CONNECT_WIFI.XML"
```


### define CONNECT_USB_SER_FILE

```cpp
#define CONNECT_USB_SER_FILE "CONNECT_USB_SER.XML"
```


### define CONNECT_USB_LAN_FILE

```cpp
#define CONNECT_USB_LAN_FILE "CONNECT_USB_LAN.XML"
```


### define CONNECT_COM1A_FILE

```cpp
#define CONNECT_COM1A_FILE "CONNECT_COM1A.XML"
```


### define CONNECT_BLE_FILE

```cpp
#define CONNECT_BLE_FILE "CONNECT_BLE.XML"
```


### define CONNECT_COM1_FILE

```cpp
#define CONNECT_COM1_FILE "CONNECT_COM1.XML"
```


### define CONNECT_ANY_FILE

```cpp
#define CONNECT_ANY_FILE "CONNECT_ANY.XML"
```


### define CONNECT_LO_FILE

```cpp
#define CONNECT_LO_FILE "CONNECT_LO.XML"
```


### define CONNECT_ANDROID_FILE

```cpp
#define CONNECT_ANDROID_FILE "CONNECT_ANDROID.XML"
```


### define BLE_GATT_FILE

```cpp
#define BLE_GATT_FILE "gatt.xml"
```


### define LOCAL_NET_BT_PAN_FILE

```cpp
#define LOCAL_NET_BT_PAN_FILE "LOCAL_NET_BT_PAN.xml"
```


### define CCP_DATABASE_FILE

```cpp
#define CCP_DATABASE_FILE "ccp.db"
```


### define COM_IF_CONFIG_FILE

```cpp
#define COM_IF_CONFIG_FILE "COM_IF.CFG"
```


### define SEC_PREFIX

```cpp
#define SEC_PREFIX "sec/"
```


### define ADKSEC_CONFIG_FILE

```cpp
#define ADKSEC_CONFIG_FILE "sccfg.json"
```


### define EPP_PREFIX

```cpp
#define EPP_PREFIX "epp/"
```


### define CT_PREFIX

```cpp
#define CT_PREFIX "ct/"
```


### define EPP_CONFIG_FILE

```cpp
#define EPP_CONFIG_FILE "epp.json"
```


### define LOCAL_NET_USB_CT

```cpp
#define LOCAL_NET_USB_CT "LOCAL_NET_USB_CT.xml"
```


### define LOCAL_NET_USB_EPP

```cpp
#define LOCAL_NET_USB_EPP "LOCAL_NET_USB_EPP.xml"
```


### define CONNECT_EPP_TLS

```cpp
#define CONNECT_EPP_TLS "CONNECT_EPP_TLS.XML"
```


### define EMV_PREFIX

```cpp
#define EMV_PREFIX "emv/"
```


### define EMV_DESIRED_FILE

```cpp
#define EMV_DESIRED_FILE "emv-desired.xml"
```


### define EMV_FLASH_CONFIG_FILES

```cpp
#define EMV_FLASH_CONFIG_FILES "EMV_.*\\.xml"
```


### define SDI_TRX_DATA_FILE

```cpp
#define SDI_TRX_DATA_FILE "sdi_trx.dat"
```


### define WHITELIST_FILE

```cpp
#define WHITELIST_FILE "whitelist.json"
```


### define SENSITIVE_TAGS_FILE

```cpp
#define SENSITIVE_TAGS_FILE "sensitivetags.json"
```


### define CARD_RANGES_FILE

```cpp
#define CARD_RANGES_FILE "cardranges.json"
```


### define STATUS_CFG_FILE

```cpp
#define STATUS_CFG_FILE "STATUS.CFG"
```


### define IDLETEXT_CFG_FILE

```cpp
#define IDLETEXT_CFG_FILE "IDLETEXT.CFG"
```


### define SDI_CONFIG_FILE

```cpp
#define SDI_CONFIG_FILE "config.json"
```


### define SDI_ACL_FILE

```cpp
#define SDI_ACL_FILE "acl.json"
```


### define FS_CHECKSUMS_FILE

```cpp
#define FS_CHECKSUMS_FILE "checksums.json"
```


### define UPDATE_REMOVE_FILE

```cpp
#define UPDATE_REMOVE_FILE "remove.json"
```


### define PLUGIN_PREFIX

```cpp
#define PLUGIN_PREFIX "plugin/"
```


### define PLUGIN_EXT

```cpp
#define PLUGIN_EXT ".so"
```


### define PLUGIN_PATTERN

```cpp
#define PLUGIN_PATTERN "libsdiplugin.*\\" PLUGIN_EXT
```


### define PLUGIN_CONFIG_PATTERN

```cpp
#define PLUGIN_CONFIG_PATTERN "libsdiplugin.*\\.(cfg|json)"
```


### define GCKERNEL_PATTERN

```cpp
#define GCKERNEL_PATTERN "libEMV_CTLS_GC[0-9]{6}\\.so"
```


### define LOG_PREFIX

```cpp
#define LOG_PREFIX "log/"
```


### define LOG_CONFIG_FILES

```cpp
#define LOG_CONFIG_FILES ".*_log\\.conf"
```


### define NFC_PREFIX

```cpp
#define NFC_PREFIX "nfc/"
```


### define NFC_WKY_FILES

```cpp
#define NFC_WKY_FILES ".*\\.wky"
```


### define FONT_PREFIX

```cpp
#define FONT_PREFIX "fonts/"
```


### define FONT_FILES

```cpp
#define FONT_FILES ".*\\.(afm|fnt|fon|gsf|otf|pfa|pfb|pfm|ttc|ttf)"
```


### define EMV_CONFIG_TARBALL

```cpp
#define EMV_CONFIG_TARBALL "emv-config.tar"
```


## Source code

```cpp
#ifndef _FILESYSTEM_
#define _FILESYSTEM_

#include <string>
#include <vector>
#include "config/sdi_sysconfig.h"

/****** SDI-SERVER FILENAME DEFINITIONS ******/

// subfolder for COM files
#define COM_PREFIX            "com/"
// subfolder for COM files used on CM5/M424/M440
#define COM_ANDROID           "com/android/"

// ADKCOM connection profiles
#define CONNECT_LAN_FILE      "CONNECT_LAN.XML"      // COM_PREFIX added later in code
#define CONNECT_BT_FILE       "CONNECT_BT.XML"       // COM_PREFIX added later in code
#define CONNECT_WIFI_FILE     "CONNECT_WIFI.XML"     // COM_PREFIX added later in code
#define CONNECT_USB_SER_FILE  "CONNECT_USB_SER.XML"  // COM_PREFIX added later in code
#define CONNECT_USB_LAN_FILE  "CONNECT_USB_LAN.XML"  // COM_PREFIX added later in code
#define CONNECT_COM1A_FILE    "CONNECT_COM1A.XML"    // COM_PREFIX added later in code
#define CONNECT_BLE_FILE      "CONNECT_BLE.XML"      // COM_PREFIX added later in code
#define CONNECT_COM1_FILE     "CONNECT_COM1.XML"     // COM_PREFIX added later in code
#define CONNECT_ANY_FILE      "CONNECT_ANY.XML"      // COM_PREFIX added later in code
#define CONNECT_LO_FILE       "CONNECT_LO.XML"       // COM_PREFIX added later in code
#define CONNECT_ANDROID_FILE  "CONNECT_ANDROID.XML"  // COM_PREFIX added later in code
// name of ADKCOM GATT server configuration file (BLE)
#define BLE_GATT_FILE         "gatt.xml"             // COM_PREFIX added later in code
// name of ADKCOM BT network profile copy in flash
#define LOCAL_NET_BT_PAN_FILE "LOCAL_NET_BT_PAN.xml" // COM_PREFIX added later in code

// name of ADKCOM CCP database file (under $HOME/flash/sdi/com)
#define CCP_DATABASE_FILE     "ccp.db"               // COM_PREFIX added later in code
// COM configuration file
#define COM_IF_CONFIG_FILE    "COM_IF.CFG"           // COM_PREFIX added later in code

/* subfolder for ADKSEC files (recently used for Android user configuration package)
 * Note: This prefix is also used by VOS user configuration packages. ADKSEC
 *       knows this path, since it set with environment variable SCAPPCFG in start file */
#define SEC_PREFIX            "sec/"
// ADKSEC configuration file
#define ADKSEC_CONFIG_FILE    "sccfg.json" // SEC_PREFIX added later in code

// subfolder for EPP files
#define EPP_PREFIX            "epp/"
// subfolder for CT files
#define CT_PREFIX             "ct/"
// EPP configuration file
#define EPP_CONFIG_FILE       "epp.json"              // EPP_PREFIX/CT_PREFIX added later in code
// CT/EPP network profiles
#define LOCAL_NET_USB_CT      "LOCAL_NET_USB_CT.xml"  // CT_PREFIX added later in code
#define LOCAL_NET_USB_EPP     "LOCAL_NET_USB_EPP.xml" // EPP_PREFIX added later in code
// ADKCOM connection profile used by EPP
#define CONNECT_EPP_TLS       "CONNECT_EPP_TLS.XML"   // EPP_PREFIX added later in code

/* subfolder for EMV files (recently used for Android user configuration package)
 * Note: ADKEMV specifies "adkemv" as prefix for internal EMV files, but this is handled
 *       by functions emv_flash_dir() and emv_config_dir(), which already add this prefix. */
#define EMV_PREFIX             "emv/"
// EMV (read-only) config file emv-desired.xml
#define EMV_DESIRED_FILE       "emv-desired.xml"
// reg-ex pattern for EMV flash configuration files
#define EMV_FLASH_CONFIG_FILES "EMV_.*\\.xml"

// SDI server specific files (don't use a prefix)
#define SDI_TRX_DATA_FILE     "sdi_trx.dat"
#define WHITELIST_FILE        "whitelist.json"
#define SENSITIVE_TAGS_FILE   "sensitivetags.json"
#define CARD_RANGES_FILE      "cardranges.json"
#define STATUS_CFG_FILE       "STATUS.CFG"
#define IDLETEXT_CFG_FILE     "IDLETEXT.CFG"
#define SDI_CONFIG_FILE       "config.json"
#define SDI_ACL_FILE          "acl.json"
#define FS_CHECKSUMS_FILE     "checksums.json"

/* Android only: removal file for command
 * 20-1D (Check for update) with upload type 8 (user config removal)
 * or with upload type 10 (plugin removal) */
#define UPDATE_REMOVE_FILE "remove.json"

// subfolder for SDI plugins (recently used for Android user configuration package)
#define PLUGIN_PREFIX            "plugin/"
// plugin file extension
#define PLUGIN_EXT ".so"
// reg-ex pattern to match SDI plugins
#define PLUGIN_PATTERN "libsdiplugin.*\\" PLUGIN_EXT
// reg-ex pattern to match SDI plugin configuration
#define PLUGIN_CONFIG_PATTERN "libsdiplugin.*\\.(cfg|json)"
// reg-ex pattern for EMV-ADK girocard kernel wrapper, any version
#define GCKERNEL_PATTERN "libEMV_CTLS_GC[0-9]{6}\\.so"

// subfolder for ADKLOG configuration files (recently used for Android user configuration package)
#define LOG_PREFIX "log/"
// ADKLOG configuration files
#define LOG_CONFIG_FILES ".*_log\\.conf"

// subfolder for ADKNFC configuration files (recently used for Android user configuration package)
#define NFC_PREFIX "nfc/"
// ADKNFC wallet key files (wky) files
#define NFC_WKY_FILES ".*\\.wky"

// subfolder for fonts (recently used by ADKPRT for Android user configuration package only)
#define FONT_PREFIX "fonts/"
// fonts files (true type font)
#define FONT_FILES ".*\\.(afm|fnt|fon|gsf|otf|pfa|pfb|pfm|ttc|ttf)"

#if defined _VOS  // grsec on VOS/VOS2 requires to put global shared files to /tmp/share
  // lock file to check another running SDI instance
  #define SDI_LOCK_FILE "/tmp/share/sdi.lock"
  // file to signal SDI server that sdi_cleaner has finished
  #define SDI_CLEANUP_DONE_FILE "/tmp/share/sdi.cleanup_done"
#elif defined _VOS3
  // lock file to check another running SDI instance
  #define SDI_LOCK_FILE "/tmp/sdi.lock"
#endif

#if defined(__ANDROID__) || defined(_VOS3)
  // default name of PEM output file containing CA for CT (EPP client), usually contains AuthEx/AuthN CA
  #define EPP_CA_PEM_FILE "epp_ca.pem"
#endif

// internal file names used by SW upload 20-14/20-15/20-16
#define EMV_CONFIG_TARBALL "emv-config.tar"
#ifdef _STM32
  // filename of uploaded download package stored in upload_install_dir()
  #define STM32_DL_FILENAME "update.tar"
  // file name of uploaded VRK package stored in upload_install_dir()
  #define STM32_UVRK_FILENAME "vrkpkg.tar"
#endif

/****** FILESYSTEM NAMESPACE & FUNCTIONS ******/

namespace sdi
{
  namespace filesystem
  {

    void init(enum config::SdiSysConfig::SDIMode sdi_mode);

    void factory_reset();

    bool read_file(const char *file, std::string &data);

    bool write_file(const char *file, const std::string &data);

    bool copy_file(const std::string &src, const std::string &dest);

    bool move_file(const std::string &src, const std::string &dest);

    int get_dir_files(const char *dir, std::vector<std::string> *files = 0, const char *regex = 0);

    enum FilesModes
    {
      FM_Default    = 0, 
      FM_NoAbort    = 1, 
      FM_Quiet      = 2, 
      FM_KeepTopDir = 4  
    };

    int copy_files(const std::vector<std::string> &files, const char *dst_dir, unsigned modes = FM_Default);

    int remove_files(const std::vector<std::string> &files, unsigned modes = FM_Default);

    int remove_dir(const std::string &path, unsigned modes = FM_Default);

    int extract_tar(const std::string &tarfile, const std::string &destdir, const char *regex = 0);

    const char* binary_dir();

    const char* home_flash_dir();
    std::string home_flash_file(const std::string &file);

    const char* home_config_dir();

    std::string home_config_file(const std::string &file);

    const char* ext_config_dir();
    std::string lookup_config_file(const std::string &file);

    const char* emv_flash_dir();

    const char* emv_config_dir();

    const char* log_config_dir();

    const char* nfc_flash_dir();

    const char* home_lib_dir();

    const char* ext_plugin_dir();

    const char* plugin_config_dir();

    const char* ext_font_dir();

    const char* tmp_dir();

    const char* upload_install_dir(bool flash = true);

    const char* sys_remove_sponsor_dir();

    const char* ccp_resource_dir();

    const char* ccp_database_dir();

    const char* sdi_update_dir();

    const char* sdi_persist_dir(bool system = false);

    const char* sdi_certstore_dir();

    /**** Functions required for command "EMV config upload (20-14/20-15/20-16)"  ****/

    unsigned short install_emv_config_package(const std::string &emv_config_pkg);

    // x86, ANDROID & Co.
#if !defined (_VOS) &&  !defined (_VOS3) && !defined (_STM32)
  /**** Functions required for command "Check for update (20-1D)" (not supported for VOS/VOS2/VOS3) ****/

  unsigned short install_user_configuration(bool recover = false);

  unsigned short remove_user_configuration();

  unsigned short install_sdi_plugins(bool recover = false);

  unsigned short remove_sdi_plugins();

#endif  // #if !defined (_VOS) && !defined (_VOS3)

  }
} // namespace sdi::filesystem

#endif
```


-------------------------------

Updated on 2025-06-17 at 11:52:25 +0100
